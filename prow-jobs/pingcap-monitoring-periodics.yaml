# struct ref: https://pkg.go.dev/k8s.io/test-infra/prow/config#Periodic
periodics:
  - name: periodic-update-pingcap-monitoring
    decorate: true # need add this.
    cron: "0 * * * *" # @hourly
    skip_report: true
    extra_refs: # Periodic job doesn't clone any repo by default, needs to be added explicitly
      - org: pingcap
        repo: monitoring
        base_ref: master
        skip_submodules: true
        clone_depth: 1
    spec:
      containers:
        - name: check
          image: golang:1.21.6
          command: [bash, -ce]
          env:
            - name: TARGET
              value: master
          resources:
            limits:
              memory: 4Gi
              cpu: "1"
          volumeMounts:
            - name: github-token
              mountPath: /etc/github
              readOnly: true              
          args:
            - |
              go run ./cmd/monitoring.go --tag=$TARGET --config monitoring.yaml
              git add monitor-snapshot/$TARGET
              if git diff --cached --exit-code; then
                echo "ðŸ¤· No changes happened."
                exit 0
              fi

              # commit and push the changes
              git config user.email "ti-community-prow-bot@tidb.io"
              git config user.name  "ti-chi-bot"
              
              # install `gh` tool
              type -p curl >/dev/null || ( apt update &&  apt install curl -y)
              curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg |  dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
              && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
              && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" |  tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
              && apt update \
              && apt install gh -y

              # login and setup git
              gh auth login --with-token < /etc/github/token
              gh auth setup-git

              # commit and push the changes.
              head_branch="fix/${TARGET}/update-snapshot-files"
              git checkout -b "$head_branch"
              commit_msg="chore(monitor-snapshot/master): update files from upstreams"
              git commit -m "$commit_msg"
              git push origin "$head_branch"

              # create pull request
              cat <<EOF > pr_body.txt
              Auto generated by bot periodics.
              EOF
              gh pr create \
                --base $TARGET \
                --head "$head_branch" \
                --fill \
                --body-file pr_body.txt
      volumes:
        - name: github-token
          secret:
            secretName: github-token
  - name: periodic-update-pingcap-monitoring-lts-7.5
    decorate: true # need add this.
    cron: "0 * * * *" # @hourly
    skip_report: true
    extra_refs: # Periodic job doesn't clone any repo by default, needs to be added explicitly
      - org: pingcap
        repo: monitoring
        base_ref: release-7.5
        skip_submodules: true
        clone_depth: 1
    spec:
      containers:
        - name: check
          image: golang:1.21.6
          command: [bash, -ce]
          env:
            - name: TARGET
              value: release-7.5
          resources:
            limits:
              memory: 4Gi
              cpu: "1"
          volumeMounts:
            - name: github-token
              mountPath: /etc/github
              readOnly: true              
          args:
            - |
              go run ./cmd/monitoring.go --tag=$TARGET --config monitoring.yaml
              git add monitor-snapshot/$TARGET
              if git diff --cached --exit-code; then
                echo "ðŸ¤· No changes happened."
                exit 0
              fi

              git config user.email "ti-community-prow-bot@tidb.io"
              git config user.name  "ti-chi-bot"
              
              # install `gh` tool
              type -p curl >/dev/null || ( apt update &&  apt install curl -y)
              curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg |  dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
              && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
              && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" |  tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
              && apt update \
              && apt install gh -y

              # login and setup git
              gh auth login --with-token < /etc/github/token
              gh auth setup-git

              # commit and push the changes.
              head_branch="fix/${TARGET}/update-snapshot-files"
              git checkout -b "$head_branch"
              commit_msg="chore(monitor-snapshot/master): update files from upstreams"
              git commit -m "$commit_msg"
              git push origin "$head_branch"

              # create pull request
              cat <<EOF > pr_body.txt
              Auto generated by bot periodics.
              EOF
              gh pr create \
                --base $TARGET \
                --head "$head_branch" \
                --fill \
                --body-file pr_body.txt
      volumes:
        - name: github-token
          secret:
            secretName: github-token
