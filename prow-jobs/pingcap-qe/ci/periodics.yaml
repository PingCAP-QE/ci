# struct ref: https://pkg.go.dev/sigs.k8s.io/prow/pkg/config#Periodic
periodics:
  - name: periodic-crawl-ci-run-data
    decorate: true # need add this.
    cron: "0 * * * *" # @hourly
    hidden: true
    spec:
      activeDeadlineSeconds: 300
      containers:
        - name: main
          image: denoland/deno:2.5.4
          command:
            - deno
            - run
            - --allow-net
            - https://github.com/PingCAP-QE/ee-apps/raw/main/insight/crawlers/ci/prow-jobs.ts
          args: [--dsn=$(DSN)]
          env:
            - name: DSN
              valueFrom:
                secretKeyRef:
                  key: ci-job-periodic-crawl-ci-run-data-dsn
                  name: ci-job-params-mono
          resources:
            requests:
              memory: 1Gi
              cpu: 200m
  - name: periodic-reporter-flaky-tests-tidb
    decorate: true # need add this.
    cron: "0 1 * * 1" # Run weekly at 9:00 UTC+8 (which is 1:00 UTC) every Monday
    hidden: true
    spec:
      activeDeadlineSeconds: 300
      containers:
        - name: main
          image: denoland/deno:2.5.4
          command: [bash, -c]
          args:
            - |
              #!/usr/bin/env bash
              set -euxo pipefail

              script_url="https://github.com/PingCAP-QE/ci/raw/main/tools/reporters/ci/flaky-tests/main.ts"
              start_date=$(date -d "7 days ago" +%Y-%m-%d)
              end_date=$(date +%Y-%m-%d)
              email_subject="Flaky Tests Report of $PARAM_REPO repository (branch: $PARAM_BRANCH) between ${start_date} and ${end_date}"

              deno run --allow-env --allow-net --allow-write ${script_url} \
                --repo ${PARAM_REPO} \
                --branch ${PARAM_BRANCH} \
                --from ${start_date} \
                --to ${end_date} \
                --threshold-ms ${PARAM_CASE_THRESHOLD_MS} \
                --db-url=${PARAM_DSN} \
                --email-to="${PARAM_EMAIL_TO}" \
                --email-cc="${PARAM_EMAIL_CC}" \
                --email-from="${SMTP_USER}" \
                --email-subject="${email_subject}"
          env:
            - name: PARAM_REPO
              value: pingcap/tidb
            - name: PARAM_BRANCH
              value: master
            - name: PARAM_CASE_THRESHOLD_MS
              value: "100000"
            - name: PARAM_DSN
              valueFrom:
                secretKeyRef:
                  key: ci-job-flay-report-dsn
                  name: ci-job-params-mono
            - name: PARAM_EMAIL_TO
              valueFrom:
                secretKeyRef:
                  key: ci-job-flay-report-email-to
                  name: ci-job-params-mono
            - name: PARAM_EMAIL_CC
              valueFrom:
                secretKeyRef:
                  key: ci-job-flay-report-email-cc
                  name: ci-job-params-mono
            - name: SMTP_SECURE
              value: "true"
            - name: SMTP_HOST
              valueFrom:
                secretKeyRef:
                  key: smtp-host
                  name: ci-smtp
            - name: SMTP_PORT
              valueFrom:
                secretKeyRef:
                  key: smtp-port
                  name: ci-smtp
            - name: SMTP_USER
              valueFrom:
                secretKeyRef:
                  key: smtp-user
                  name: ci-smtp
            - name: SMTP_PASS
              valueFrom:
                secretKeyRef:
                  key: smtp-password
                  name: ci-smtp
          resources:
            requests:
              memory: 1Gi
              cpu: 200m
