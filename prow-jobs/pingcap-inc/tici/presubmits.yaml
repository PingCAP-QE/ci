global_definitions:
  brancher: &brancher
    branches:
      - ^master$
    # skip_branches: # skip feature branches based on released version.
    #   - ^feature/release-\d+\.\d+(.\d+)?-.+$
  skip_if_only_changed: &skip_if_only_changed "(\\.(md|png|jpeg|jpg|gif|svg|pdf|gitignore)|Dockerfile|OWNERS|OWNERS_ALIASES)$"

  decoration_config: &decoration_config
    timeout: 100m
    oauth_token_secret:
      name: github-token
      key: token

# struct ref: https://pkg.go.dev/sigs.k8s.io/prow/pkg/config#Presubmit
presubmits:
  pingcap-inc/tici:
    - <<: *brancher
      name: pull-verify
      decorate: true
      decoration_config: *decoration_config
      skip_if_only_changed: *skip_if_only_changed
      spec:
        containers:
          - name: build-debug
            image: ghcr.io/pingcap-qe/ci/tici:v2025.10.12-22-g0eba311
            command: [/bin/bash, -ce]
            args:
              - |
                set -exo pipefail
                # Verify Rust environment
                echo "Rust version: $(rustc --version)"
                echo "Cargo version: $(cargo --version)"

                # Build the tici-server binary
                make build

                # Run tici-server to display version
                ./target/debug/tici-server --version || { echo "Failed to run tici-server"; exit 1; }

                # check format & clippy & bench compile
                make check

                # Run unit tests
                make ci-ut
            resources:
              requests:
                cpu: "6"
                memory: 24Gi
              limits:
                cpu: "6"
                memory: 24Gi

    - <<: *brancher
      name: pull-it
      decorate: true
      decoration_config: *decoration_config
      skip_if_only_changed: *skip_if_only_changed
      spec:
        containers:
          - name: it
            image: ghcr.io/pingcap-qe/ci/tici:v2025.10.12-22-g0eba311
            command: [/bin/bash, -ce]
            env:
              - name: ASSET_DIR
                value: /cache
            args:
              - |
                set -exo pipefail
                echo "Preparing test assets..."
                mkdir -p /cache
                wget -qO - https://quickwit-datasets-public.s3.amazonaws.com/hdfs-logs-multitenants.json.gz | gzip -d - > /cache/hdfs-logs-multitenants.json
                echo "Running tests..."
                make ci-prepare-it
                make ci-run-it
            resources:
              requests:
                cpu: "6"
                memory: 24Gi
              limits:
                cpu: "6"
                memory: 24Gi

    - <<: *brancher
      name: pull-e2e
      decorate: true
      decoration_config: *decoration_config
      skip_if_only_changed: *skip_if_only_changed
      spec:
        containers:
          - name: e2e
            image: ghcr.io/pingcap-qe/ci/tici:v2025.10.12-22-g0eba311
            command: [/bin/bash, -ce]
            env:
              - name: ASSET_DIR
                value: /cache
            args:
              - |
                set -exo pipefail
                echo "Preparing test assets..."
                mkdir -p /cache
                wget -qO - https://quickwit-datasets-public.s3.amazonaws.com/hdfs-logs-multitenants.json.gz | gzip -d - > /cache/hdfs-logs-multitenants.json
                echo "Running tests..."
                make ci-e2e
            resources:
              requests:
                cpu: "8"
                memory: 24Gi
              limits:
                cpu: "8"
                memory: 24Gi
