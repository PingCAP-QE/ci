# struct ref: https://pkg.go.dev/k8s.io/test-infra/prow/config#Periodic
periodics:
  - name: periodic-update-pingcap-monitoring
    decorate: true # need add this.
    cron: "0 * * * *" # @hourly
    skip_report: true
    extra_refs: # Periodic job doesn't clone any repo by default, needs to be added explicitly
      - org: pingcap
        repo: monitoring
        base_ref: master
        skip_submodules: true
        clone_depth: 1
    spec:
      activeDeadlineSeconds: 3600
      containers:
        - name: check
          image: golang:1.21.11
          env:
            - name: TARGET
              value: master
          resources:
            limits:
              memory: 4Gi
              cpu: "1"
          volumeMounts:
            - name: github-token
              mountPath: /etc/github
              readOnly: true
          command: [bash, -ceo, pipefail]
          args: &args
            - |
              if go run ./cmd/monitoring.go --tag $TARGET --config monitoring.yaml --token $(cat /etc/github/token); then
                git add monitor-snapshot/$TARGET
                # should ignore the file: monitor-snapshot/$TARGET/ansible-monitor.tar.gz, it will be different in every compressing.
                if git diff --cached --exit-code --name-status monitor-snapshot/$TARGET/operator; then
                  echo "🤷 No changes happened."
                  exit 0
                fi
              else
                echo "❌ tool run failed!"
                exit 1
              fi

              # commit and push the changes
              git config user.email "ti-community-prow-bot@tidb.io"
              git config user.name  "ti-chi-bot"

              # install `gh` tool
              type -p curl >/dev/null || ( apt update &&  apt install curl -y)
              curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg |  dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
              && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
              && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" |  tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
              && apt update \
              && apt install gh -y

              # login and setup git
              gh auth login --with-token < /etc/github/token
              gh auth setup-git

              # commit and push the changes.
              head_branch="fix/${TARGET}/update-snapshot-files"
              git checkout -b "$head_branch"
              commit_msg="chore(monitor-snapshot/$TARGET): update files from upstreams"
              git commit -m "$commit_msg"
              git remote add origin https://github.com/pingcap/monitoring.git
              git remote -v
              git push -f --set-upstream origin "$head_branch"

              # create pull request
              gh pr create \
                --base $TARGET \
                --head "$head_branch" \
                --title "$commit_msg" \
                --body "Auto generated by bot periodics."

              # wait 120 seconds, let the bot deal firstly.
              sleep 120

              # add lgtm and approved labels.
              prUrl=$(gh pr list \
                --repo pingcap/monitoring \
                --base $TARGET \
                --head "$head_branch" \
                --state open \
                --json "url" \
                --jq .[].url)
              gh pr edit --add-label lgtm --add-label approved $prUrl
      volumes:
        - name: github-token
          secret:
            secretName: github-token
  - name: periodic-update-pingcap-monitoring-dmr-8.2
    decorate: true # need add this.
    cron: "0 * * * *" # @hourly
    skip_report: true
    extra_refs: # Periodic job doesn't clone any repo by default, needs to be added explicitly
      - org: pingcap
        repo: monitoring
        base_ref: release-8.2
        skip_submodules: true
        clone_depth: 1
    spec:
      containers:
        - name: check
          image: golang:1.21.11
          command: [bash, -ce]
          env:
            - name: TARGET
              value: release-8.2
          resources:
            limits:
              memory: 4Gi
              cpu: "1"
          volumeMounts:
            - name: github-token
              mountPath: /etc/github
              readOnly: true
          args: *args
      volumes:
        - name: github-token
          secret:
            secretName: github-token
  - name: periodic-update-pingcap-monitoring-lts-8.1
    decorate: true # need add this.
    cron: "0 * * * *" # @hourly
    skip_report: true
    extra_refs: # Periodic job doesn't clone any repo by default, needs to be added explicitly
      - org: pingcap
        repo: monitoring
        base_ref: release-8.1
        skip_submodules: true
        clone_depth: 1
    spec:
      containers:
        - name: check
          image: golang:1.21.11
          command: [bash, -ce]
          env:
            - name: TARGET
              value: release-8.1
          resources:
            limits:
              memory: 4Gi
              cpu: "1"
          volumeMounts:
            - name: github-token
              mountPath: /etc/github
              readOnly: true
          args: *args
      volumes:
        - name: github-token
          secret:
            secretName: github-token
  - name: periodic-update-pingcap-monitoring-lts-7.5
    decorate: true # need add this.
    cron: "5 7 * * *" # @daily
    skip_report: true
    extra_refs: # Periodic job doesn't clone any repo by default, needs to be added explicitly
      - org: pingcap
        repo: monitoring
        base_ref: release-7.5
        skip_submodules: true
        clone_depth: 1
    spec:
      containers:
        - name: check
          image: golang:1.21.11
          command: [bash, -ce]
          env:
            - name: TARGET
              value: release-7.5
          resources:
            limits:
              memory: 4Gi
              cpu: "1"
          volumeMounts:
            - name: github-token
              mountPath: /etc/github
              readOnly: true
          args: *args
      volumes:
        - name: github-token
          secret:
            secretName: github-token
  - name: periodic-update-pingcap-monitoring-lts-7.1
    decorate: true # need add this.
    cron: "1 7 * * *" # @daily
    skip_report: true
    extra_refs: # Periodic job doesn't clone any repo by default, needs to be added explicitly
      - org: pingcap
        repo: monitoring
        base_ref: release-7.1
        skip_submodules: true
        clone_depth: 1
    spec:
      containers:
        - name: check
          image: golang:1.21.11
          command: [bash, -ce]
          env:
            - name: TARGET
              value: release-7.1
          resources:
            limits:
              memory: 4Gi
              cpu: "1"
          volumeMounts:
            - name: github-token
              mountPath: /etc/github
              readOnly: true
          args: *args
      volumes:
        - name: github-token
          secret:
            secretName: github-token
  - name: periodic-update-pingcap-monitoring-lts-6.5
    decorate: true # need add this.
    cron: "5 6 * * *" # @daily
    skip_report: true
    extra_refs: # Periodic job doesn't clone any repo by default, needs to be added explicitly
      - org: pingcap
        repo: monitoring
        base_ref: release-6.5
        skip_submodules: true
        clone_depth: 1
    spec:
      containers:
        - name: check
          image: golang:1.19.13
          command: [bash, -ce]
          env:
            - name: TARGET
              value: release-6.5
          resources:
            limits:
              memory: 4Gi
              cpu: "1"
          volumeMounts:
            - name: github-token
              mountPath: /etc/github
              readOnly: true
          args: *args
      volumes:
        - name: github-token
          secret:
            secretName: github-token
  - name: periodic-update-pingcap-monitoring-lts-6.1
    decorate: true # need add this.
    cron: "1 6 * * *" # @daily
    skip_report: true
    extra_refs: # Periodic job doesn't clone any repo by default, needs to be added explicitly
      - org: pingcap
        repo: monitoring
        base_ref: release-6.1
        skip_submodules: true
        clone_depth: 1
    spec:
      containers:
        - name: check
          image: golang:1.19.13
          command: [bash, -ce]
          env:
            - name: TARGET
              value: release-6.1
          resources:
            limits:
              memory: 4Gi
              cpu: "1"
          volumeMounts:
            - name: github-token
              mountPath: /etc/github
              readOnly: true
          args: *args
      volumes:
        - name: github-token
          secret:
            secretName: github-token
