global_definitions:
  branches: &branches
    - ^release-2[.][0-9]+$
    - ^main$
  e2e_kind_branches: &e2e_kind_branches
    - ^release-1[.][0-9]+$
    - ^master$
  skip_if_only_changed: &skip_if_only_changed
    "(\\.(md|png|jpeg|jpg|gif|svg|pdf)|OWNERS|OWNERS_ALIASES)$"
  decoration_config: &decoration_config
    timeout: 3h


# struct ref: https://pkg.go.dev/sigs.k8s.io/prow/pkg/config#Presubmit
presubmits:
  pingcap/tidb-operator:
    - name: auto-trigger-ready-for-review
      decorate: true
      always_run: false
      decoration_config:
        timeout: 45m
        skip_cloning: true
      skip_report: true
      optional: true
      branches: *branches
      skip_submodules: true
      max_concurrency: 3
      trigger: "(?m)^/test (?:.*? )?ready-for-review(?: .*?)?$"
      rerun_command: "/test ready-for-review"

      spec:
        containers:
          - name: main
            image: maniator/gh:v2.83.2
            env:
              - name: GH_TOKEN
                valueFrom:
                  secretKeyRef:
                    key: token
                    name: github-token
            command:
            - gh
            - pr
            - ready
            - $(PULL_NUMBER)
            - --repo
            - pingcap/tidb-operator

    - name: pull-e2e
      decorate: true # need add this.
      decoration_config: *decoration_config
      skip_if_only_changed: *skip_if_only_changed
      branches: *branches
      spec:
        nodeSelector:
          node.kubernetes.io/instance-type: e2-highmem-8
        volumes:
          - name: docker-sock-dir
            emptyDir: {}
          - name: data
            ephemeral:
              volumeClaimTemplate:
                metadata:
                  labels:
                    type: ephemeral
                spec:
                  accessModes: ["ReadWriteOnce"]
                  storageClassName: "standard-rwo"
                  resources:
                    requests:
                      storage: 500Gi
        initContainers:
          - name: dind-daemon
            image: docker:28.1-dind
            restartPolicy: Always
            command:
            - /bin/sh
            - -c
            - "dockerd-entrypoint.sh --cgroup-parent /kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod$(echo ${POD_UID} | tr - _).slice"
            env:
            - name: DOCKER_TLS_CERTDIR
              value: ""
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            securityContext:
              privileged: true
            volumeMounts:
              - name: docker-sock-dir
                mountPath: /var/run
              - name: data
                mountPath: /var/lib/docker
                subPath: docker
            resources:
              requests:
                memory: "28Gi"
                cpu: "1"
              limits:
                memory: "28Gi"
                cpu: "1"
        containers:
          - name: e2e-runner
            image: ubuntu:22.04
            command: ["/bin/sh", "-ce"]
            args:
              - |
                set -ex
                export DEBIAN_FRONTEND=noninteractive
                apt-get update
                apt-get install -y --no-install-recommends \
                  ca-certificates \
                  curl \
                  git \
                  make \
                  cmake \
                  tar

                # Add Docker's official GPG key
                install -m 0755 -d /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
                chmod a+r /etc/apt/keyrings/docker.asc

                # Add the repository to Apt sources
                echo \
                  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
                  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
                  tee /etc/apt/sources.list.d/docker.list > /dev/null
                apt-get update

                # Install Docker CLI
                apt-get install -y --no-install-recommends docker-ce-cli docker-buildx-plugin

                # Install Go 1.23
                curl -fsSL https://go.dev/dl/go1.23.10.linux-amd64.tar.gz | tar -C /usr/local -xz
                export PATH=/usr/local/go/bin:$PATH
                export GOPATH=/go
                export GOCACHE=/tmp/go-cache

                echo "Go version: $(go version)"
                echo "Docker version: $(docker version --format '{{.Client.Version}}')"

                echo "Waiting for Docker daemon to be responsive..."
                timeout_seconds=120
                # Loop until docker info succeeds or timeout is reached
                start_time=$(date +%s)
                while ! docker info > /dev/null 2>&1; do
                  current_time=$(date +%s)
                  elapsed=$((current_time - start_time))
                  if [ $elapsed -ge $timeout_seconds ]; then
                    echo "Error: Docker daemon did not start within ${timeout_seconds} seconds." >&2
                    echo "Listing contents of /var/run to help debug:" >&2
                    ls -la /var/run || echo "Warning: Failed to list /var/run" >&2
                    exit 1
                  fi
                  echo "Waiting for Docker... $(date)"
                  sleep 5
                done
                echo "Docker daemon is responsive."

                make kube
                docker update tidb-operator-control-plane --memory-reservation=6G -c 2048
                docker update tidb-operator-worker -m 16G --memory-swap 16G -c 4096
                docker update tidb-operator-worker2 -m 16G --memory-swap 16G -c 4096
                docker update tidb-operator-worker3 -m 16G --memory-swap 16G -c 4096
                CI=true GINKGO_OPTS='--procs=4' make e2e
            volumeMounts:
              - name: docker-sock-dir
                mountPath: /var/run # Mount the shared socket directory
              - name: data
                mountPath: /data
                subPath: data
            resources:
              requests:
                memory: 28Gi
                cpu: "5"
              limits:
                memory: 28Gi
                cpu: "5"

    # ========== E2E-Kind jobs（migrate from old Jenkins in ci.pingcap.net）==========
    - name: pull-e2e-kind-tidbcluster
      decorate: true
      decoration_config: *decoration_config
      skip_if_only_changed: *skip_if_only_changed
      branches: *e2e_kind_branches
      always_run: false
      optional: true
      trigger: "(?m)^/(run-all-tests$|run-pull-e2e-kind-tidbcluster(\\s.*|$)|run-e2e-tests$|retest$)"
      rerun_command: "/run-pull-e2e-kind-tidbcluster"
      spec:
        volumes:
          - name: docker-sock-dir
            emptyDir: {}
          - name: data
            ephemeral:
              volumeClaimTemplate:
                metadata:
                  labels:
                    type: ephemeral
                spec:
                  accessModes: ["ReadWriteOnce"]
                  storageClassName: "standard-rwo"
                  resources:
                    requests:
                      storage: 250Gi
          - name: modules
            hostPath:
              path: /lib/modules
              type: Directory
          - name: cgroup
            hostPath:
              path: /sys/fs/cgroup
              type: Directory
          - name: kubeconfig
            emptyDir: {}
          - name: kind-data
            emptyDir: {}
        initContainers:
          - name: dind-daemon
            image: docker:28.1-dind
            restartPolicy: Always
            command:
            - /bin/sh
            - -c
            - "dockerd-entrypoint.sh --cgroup-parent /kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod$(echo ${POD_UID} | tr - _).slice"
            env:
            - name: DOCKER_TLS_CERTDIR
              value: ""
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            securityContext:
              privileged: true
            volumeMounts:
              - name: docker-sock-dir
                mountPath: /var/run
              - name: data
                mountPath: /var/lib/docker
                subPath: docker
              - name: modules
                mountPath: /lib/modules
                readOnly: true
              - name: cgroup
                mountPath: /sys/fs/cgroup
              - name: kubeconfig
                mountPath: /kubeconfig
              - name: kind-data
                mountPath: /kind-data
            resources:
              requests:
                memory: "64Gi"
                cpu: "16"
              limits:
                memory: "64Gi"
                cpu: "16"
        containers:
          - name: e2e-runner
            image: ubuntu:22.04
            command: ["bash", "-ce"]
            args:
              - |
                #!/usr/bin/env bash
                set -ex
                export DEBIAN_FRONTEND=noninteractive
                apt-get update
                apt-get install -y --no-install-recommends \
                  ca-certificates \
                  curl \
                  git \
                  make \
                  cmake \
                  tar \
                  jq \
                  coreutils

                # Install Docker CLI
                install -m 0755 -d /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
                chmod a+r /etc/apt/keyrings/docker.asc
                echo \
                  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
                  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
                  tee /etc/apt/sources.list.d/docker.list > /dev/null
                apt-get update
                apt-get install -y --no-install-recommends docker-ce-cli docker-buildx-plugin

                # Install Go
                curl -fsSL https://go.dev/dl/go1.23.10.linux-amd64.tar.gz | tar -C /usr/local -xz
                export PATH=/usr/local/go/bin:$PATH
                export GOPATH=/go
                export GOCACHE=/tmp/go-cache

                echo "Waiting for Docker daemon..."
                timeout_seconds=120
                start_time=$(date +%s)
                while ! docker info > /dev/null 2>&1; do
                  current_time=$(date +%s)
                  elapsed=$((current_time - start_time))
                  if [ $elapsed -ge $timeout_seconds ]; then
                    echo "Error: Docker daemon did not start within ${timeout_seconds} seconds." >&2
                    exit 1
                  fi
                  sleep 5
                done
                echo "Docker daemon is responsive."

                # 编译 TiDB Operator 和相关测试工具，并配置代码覆盖率收集。
                cd /workspace/go/src/github.com/pingcap/tidb-operator
                ./hack/e2e-patch-codecov.sh || true
                unset GOSUMDB
                E2E=y make build e2e-build
                make gocovmerge || true

                GITHASH=$(git rev-parse HEAD)
                IMAGE_TAG="e2e-${GITHASH:0:6}"

                echo "Building images locally..."
                E2E=y DOCKER_REPO=tidb-operator-e2e IMAGE_TAG=${IMAGE_TAG} make docker e2e-docker

                mount --make-rshared / || true
                mkdir -p /kind-data/control-plane/coverage
                mkdir -p /kind-data/worker1/coverage
                mkdir -p /kind-data/worker2/coverage
                mkdir -p /kind-data/worker3/coverage
                mkdir -p /mnt/tmpfs/etcd

                PROVIDER=kind KIND_DATA_HOSTPATH=/kind-data KIND_ETCD_DATADIR=/mnt/tmpfs/etcd SKIP_BUILD=y SKIP_IMAGE_BUILD=y SKIP_TEST=y SKIP_DOWN=y ./hack/e2e.sh

                test -f /root/.kube/config || { echo "ERROR: /root/.kube/config not found"; exit 1; }
                install -d -m 0755 /kubeconfig
                install -m 0644 /root/.kube/config /kubeconfig/admin.conf
                export KUBECONFIG=/kubeconfig/admin.conf

                echo "Creating coverage directories in kind nodes..."
                docker exec tidb-operator-control-plane mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker2 mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker3 mkdir -p /mnt/disks/coverage || true

                KIND_BIN="kind"
                if ! command -v kind >/dev/null 2>&1; then
                  KIND_VERSION="v0.19.0"
                  curl -fsSL "https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-amd64" -o /usr/local/bin/kind
                  chmod +x /usr/local/bin/kind
                  KIND_BIN="/usr/local/bin/kind"
                fi
                echo "Loading images into kind cluster..."
                for img in $(docker images --format "{{.Repository}}:{{.Tag}}" | grep "tidb-operator-e2e/.*:${IMAGE_TAG}$"); do
                  "${KIND_BIN}" load docker-image "${img}" --name tidb-operator || { echo "Failed to load ${img} into kind"; exit 1; }
                done

                # Update kind node resources
                docker update tidb-operator-control-plane --memory-reservation=6G -c 8192
                docker update tidb-operator-worker -m 16G --memory-swap 16G -c 4096
                docker update tidb-operator-worker2 -m 16G --memory-swap 16G -c 4096
                docker update tidb-operator-worker3 -m 16G --memory-swap 16G -c 4096

                echo "Run tests..."
                export GINKGO_NO_COLOR=y
                export DELETE_NAMESPACE_ON_FAILURE=false
                export ARTIFACTS=/workspace/go/src/github.com/pingcap/tidb-operator/_artifacts
                mkdir -p ${ARTIFACTS}

                timeout 7200 env \
                  E2E=y \
                  SKIP_BUILD=y \
                  SKIP_IMAGE_BUILD=y \
                  SKIP_UP=y \
                  SKIP_DOWN=y \
                  SKIP_IMAGE_LOAD=y \
                  KUBECONFIG=/kubeconfig/admin.conf \
                  DOCKER_REPO=tidb-operator-e2e \
                  IMAGE_TAG=${IMAGE_TAG} \
                  KIND_DATA_HOSTPATH=/kind-data \
                  KIND_ETCD_DATADIR=/mnt/tmpfs/etcd \
                  DELETE_NAMESPACE_ON_FAILURE=false \
                  GINKGO_NO_COLOR=y \
                  GINKGO_NODES=3 \
                  ./hack/e2e.sh -- --ginkgo.focus='TiDBCluster' --ginkgo.skip="\[TiDBCluster:\sBasic\]" || {
                  EXIT_CODE=$?
                  
                  if [ $EXIT_CODE -eq 124 ]; then
                    echo "ERROR: Test execution timed out after 2 hours"
                  else
                    echo "ERROR: Test execution failed with exit code $EXIT_CODE"
                  fi
                  
                  exit $EXIT_CODE
                }

                echo "Merging coverage files..."
                mkdir -p /tmp/coverage-merge
                cp /kind-data/control-plane/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker1/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker2/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker3/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                
                if [ -n "$(ls -A /tmp/coverage-merge/*.cov 2>/dev/null)" ]; then
                  echo "Merging coverage files..."
                  ./bin/gocovmerge /tmp/coverage-merge/*.cov > ${ARTIFACTS}/coverage.txt || true
                  echo "Coverage merge completed"
                else
                  echo "No coverage files found, skipping merge and upload"
                fi

                echo "Test execution completed"
            env:
              - name: ARTIFACTS
                value: /workspace/go/src/github.com/pingcap/tidb-operator/_artifacts
              - name: CODECOV_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: codecov-tokens
                    key: pingcap-tidb-operator
            volumeMounts:
              - name: docker-sock-dir
                mountPath: /var/run
              - name: data
                mountPath: /data
                subPath: data
              - name: modules
                mountPath: /lib/modules
                readOnly: true
              - name: cgroup
                mountPath: /sys/fs/cgroup
              - name: kubeconfig
                mountPath: /kubeconfig
              - name: kind-data
                mountPath: /kind-data
            resources:
              requests:
                memory: 24Gi
                cpu: "3"
              limits:
                memory: 24Gi
                cpu: "3"
    
    - name: pull-e2e-kind-dmcluster
      decorate: true
      decoration_config: *decoration_config
      skip_if_only_changed: *skip_if_only_changed
      branches: *e2e_kind_branches
      always_run: false
      optional: true
      trigger: "(?m)^/(run-all-tests$|run-pull-e2e-kind-dmcluster(\\s.*|$)|run-e2e-tests$|retest$)"
      rerun_command: "/run-pull-e2e-kind-dmcluster"
      spec:
        volumes:
          - name: docker-sock-dir
            emptyDir: {}
          - name: data
            ephemeral:
              volumeClaimTemplate:
                metadata:
                  labels:
                    type: ephemeral
                spec:
                  accessModes: ["ReadWriteOnce"]
                  storageClassName: "standard-rwo"
                  resources:
                    requests:
                      storage: 250Gi
          - name: modules
            hostPath:
              path: /lib/modules
              type: Directory
          - name: cgroup
            hostPath:
              path: /sys/fs/cgroup
              type: Directory
          - name: kubeconfig
            emptyDir: {}
          - name: kind-data
            emptyDir: {}
        initContainers:
          - name: dind-daemon
            image: docker:28.1-dind
            restartPolicy: Always
            command:
            - /bin/sh
            - -c
            - "dockerd-entrypoint.sh --cgroup-parent /kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod$(echo ${POD_UID} | tr - _).slice"
            env:
            - name: DOCKER_TLS_CERTDIR
              value: ""
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            securityContext:
              privileged: true
            volumeMounts:
              - name: docker-sock-dir
                mountPath: /var/run
              - name: data
                mountPath: /var/lib/docker
                subPath: docker
              - name: modules
                mountPath: /lib/modules
                readOnly: true
              - name: cgroup
                mountPath: /sys/fs/cgroup
              - name: kubeconfig
                mountPath: /kubeconfig
              - name: kind-data
                mountPath: /kind-data
            resources:
              requests:
                memory: "32Gi"
                cpu: "8"
              limits:
                memory: "32Gi"
                cpu: "8"
        containers:
          - name: e2e-runner
            image: ubuntu:22.04
            command: ["bash", "-ce"]
            args:
              - |
                #!/usr/bin/env bash
                set -ex
                export DEBIAN_FRONTEND=noninteractive
                apt-get update
                apt-get install -y --no-install-recommends \
                  ca-certificates \
                  curl \
                  git \
                  make \
                  cmake \
                  tar \
                  jq \
                  coreutils

                # Install Docker CLI
                install -m 0755 -d /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
                chmod a+r /etc/apt/keyrings/docker.asc
                echo \
                  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
                  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
                  tee /etc/apt/sources.list.d/docker.list > /dev/null
                apt-get update
                apt-get install -y --no-install-recommends docker-ce-cli docker-buildx-plugin

                # Install Go
                curl -fsSL https://go.dev/dl/go1.23.10.linux-amd64.tar.gz | tar -C /usr/local -xz
                export PATH=/usr/local/go/bin:$PATH
                export GOPATH=/go
                export GOCACHE=/tmp/go-cache

                echo "Waiting for Docker daemon..."
                timeout_seconds=120
                start_time=$(date +%s)
                while ! docker info > /dev/null 2>&1; do
                  current_time=$(date +%s)
                  elapsed=$((current_time - start_time))
                  if [ $elapsed -ge $timeout_seconds ]; then
                    echo "Error: Docker daemon did not start within ${timeout_seconds} seconds." >&2
                    exit 1
                  fi
                  sleep 5
                done
                echo "Docker daemon is responsive."

                cd /workspace/go/src/github.com/pingcap/tidb-operator
                ./hack/e2e-patch-codecov.sh || true
                unset GOSUMDB
                E2E=y make build e2e-build
                make gocovmerge || true

                GITHASH=$(git rev-parse HEAD)
                IMAGE_TAG="e2e-${GITHASH:0:6}"

                echo "Building images locally..."
                E2E=y DOCKER_REPO=tidb-operator-e2e IMAGE_TAG=${IMAGE_TAG} make docker e2e-docker

                mount --make-rshared / || true
                mkdir -p /kind-data/control-plane/coverage
                mkdir -p /kind-data/worker1/coverage
                mkdir -p /kind-data/worker2/coverage
                mkdir -p /kind-data/worker3/coverage
                mkdir -p /mnt/tmpfs/etcd

                PROVIDER=kind KIND_DATA_HOSTPATH=/kind-data KIND_ETCD_DATADIR=/mnt/tmpfs/etcd SKIP_BUILD=y SKIP_IMAGE_BUILD=y SKIP_TEST=y SKIP_DOWN=y ./hack/e2e.sh

                test -f /root/.kube/config || { echo "ERROR: /root/.kube/config not found"; exit 1; }
                install -d -m 0755 /kubeconfig
                install -m 0644 /root/.kube/config /kubeconfig/admin.conf
                export KUBECONFIG=/kubeconfig/admin.conf

                echo "Creating coverage directories in kind nodes..."
                docker exec tidb-operator-control-plane mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker2 mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker3 mkdir -p /mnt/disks/coverage || true

                KIND_BIN="kind"
                if ! command -v kind >/dev/null 2>&1; then
                  KIND_VERSION="v0.19.0"
                  curl -fsSL "https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-amd64" -o /usr/local/bin/kind
                  chmod +x /usr/local/bin/kind
                  KIND_BIN="/usr/local/bin/kind"
                fi
                echo "Loading images into kind cluster..."
                for img in $(docker images --format "{{.Repository}}:{{.Tag}}" | grep "tidb-operator-e2e/.*:${IMAGE_TAG}$"); do
                  "${KIND_BIN}" load docker-image "${img}" --name tidb-operator || { echo "Failed to load ${img} into kind"; exit 1; }
                done

                # Update kind node resources
                docker update tidb-operator-control-plane --memory-reservation=6G -c 4096
                docker update tidb-operator-worker -m 16G --memory-swap 16G -c 4096
                docker update tidb-operator-worker2 -m 16G --memory-swap 16G -c 4096
                docker update tidb-operator-worker3 -m 16G --memory-swap 16G -c 4096

                echo "Run tests..."
                export GINKGO_NO_COLOR=y
                export DELETE_NAMESPACE_ON_FAILURE=false
                export ARTIFACTS=/workspace/go/src/github.com/pingcap/tidb-operator/_artifacts
                mkdir -p ${ARTIFACTS}

                timeout 7200 env \
                  E2E=y \
                  SKIP_BUILD=y \
                  SKIP_IMAGE_BUILD=y \
                  SKIP_UP=y \
                  SKIP_DOWN=y \
                  SKIP_IMAGE_LOAD=y \
                  KUBECONFIG=/kubeconfig/admin.conf \
                  DOCKER_REPO=tidb-operator-e2e \
                  IMAGE_TAG=${IMAGE_TAG} \
                  KIND_DATA_HOSTPATH=/kind-data \
                  KIND_ETCD_DATADIR=/mnt/tmpfs/etcd \
                  DELETE_NAMESPACE_ON_FAILURE=false \
                  GINKGO_NO_COLOR=y \
                  GINKGO_NODES=2 \
                  ./hack/e2e.sh -- --ginkgo.focus='DMCluster' || {
                  EXIT_CODE=$?
                  
                  if [ $EXIT_CODE -eq 124 ]; then
                    echo "ERROR: Test execution timed out after 2 hours"
                  else
                    echo "ERROR: Test execution failed with exit code $EXIT_CODE"
                  fi
                  
                  exit $EXIT_CODE
                }

                echo "Merging coverage files..."
                mkdir -p /tmp/coverage-merge
                cp /kind-data/control-plane/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker1/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker2/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker3/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                
                if [ -n "$(ls -A /tmp/coverage-merge/*.cov 2>/dev/null)" ]; then
                  echo "Merging coverage files..."
                  ./bin/gocovmerge /tmp/coverage-merge/*.cov > ${ARTIFACTS}/coverage.txt || true
                  echo "Coverage merge completed"
                else
                  echo "No coverage files found, skipping merge and upload"
                fi

                echo "Test execution completed"
            env:
              - name: ARTIFACTS
                value: /workspace/go/src/github.com/pingcap/tidb-operator/_artifacts
              - name: CODECOV_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: codecov-tokens
                    key: pingcap-tidb-operator
            volumeMounts:
              - name: docker-sock-dir
                mountPath: /var/run
              - name: data
                mountPath: /data
                subPath: data
              - name: modules
                mountPath: /lib/modules
                readOnly: true
              - name: cgroup
                mountPath: /sys/fs/cgroup
              - name: kubeconfig
                mountPath: /kubeconfig
              - name: kind-data
                mountPath: /kind-data
            resources:
              requests:
                memory: 24Gi
                cpu: "3"
              limits:
                memory: 24Gi
                cpu: "3"

    - name: pull-e2e-kind-basic
      decorate: true
      decoration_config: *decoration_config
      skip_if_only_changed: *skip_if_only_changed
      branches: *e2e_kind_branches
      always_run: false
      optional: true
      trigger: "(?m)^/(run-all-tests$|run-pull-e2e-kind-basic(\\s.*|$)|run-e2e-tests$|retest$)"
      rerun_command: "/run-pull-e2e-kind-basic"
      spec:
        volumes:
          - name: docker-sock-dir
            emptyDir: {}
          - name: data
            ephemeral:
              volumeClaimTemplate:
                metadata:
                  labels:
                    type: ephemeral
                spec:
                  accessModes: ["ReadWriteOnce"]
                  storageClassName: "standard-rwo"
                  resources:
                    requests:
                      storage: 250Gi
          - name: modules
            hostPath:
              path: /lib/modules
              type: Directory
          - name: cgroup
            hostPath:
              path: /sys/fs/cgroup
              type: Directory
          - name: kubeconfig
            emptyDir: {}
          - name: kind-data
            emptyDir: {}
        initContainers:
          - name: dind-daemon
            image: docker:28.1-dind
            restartPolicy: Always
            command:
            - /bin/sh
            - -c
            - "dockerd-entrypoint.sh --cgroup-parent /kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod$(echo ${POD_UID} | tr - _).slice"
            env:
            - name: DOCKER_TLS_CERTDIR
              value: ""
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            securityContext:
              privileged: true
            volumeMounts:
              - name: docker-sock-dir
                mountPath: /var/run
              - name: data
                mountPath: /var/lib/docker
                subPath: docker
              - name: modules
                mountPath: /lib/modules
                readOnly: true
              - name: cgroup
                mountPath: /sys/fs/cgroup
              - name: kubeconfig
                mountPath: /kubeconfig
              - name: kind-data
                mountPath: /kind-data
            resources:
              requests:
                memory: "32Gi"
                cpu: "8"
              limits:
                memory: "32Gi"
                cpu: "8"
        containers:
          - name: e2e-runner
            image: ubuntu:22.04
            command: ["bash", "-ce"]
            args:
              - |
                #!/usr/bin/env bash
                set -ex
                export DEBIAN_FRONTEND=noninteractive
                
                # Install basic tools
                apt-get update
                apt-get install -y --no-install-recommends \
                  ca-certificates \
                  curl \
                  git \
                  make \
                  cmake \
                  tar \
                  jq \
                  coreutils

                # Install Docker CLI
                install -m 0755 -d /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
                chmod a+r /etc/apt/keyrings/docker.asc
                echo \
                  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
                  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
                  tee /etc/apt/sources.list.d/docker.list > /dev/null
                apt-get update
                apt-get install -y --no-install-recommends docker-ce-cli docker-buildx-plugin

                # Install Go
                curl -fsSL https://go.dev/dl/go1.23.10.linux-amd64.tar.gz | tar -C /usr/local -xz
                export PATH=/usr/local/go/bin:$PATH
                export GOPATH=/go
                export GOCACHE=/tmp/go-cache

                echo "Waiting for Docker daemon..."
                timeout_seconds=120
                start_time=$(date +%s)
                while ! docker info > /dev/null 2>&1; do
                  current_time=$(date +%s)
                  elapsed=$((current_time - start_time))
                  if [ $elapsed -ge $timeout_seconds ]; then
                    echo "Error: Docker daemon did not start within ${timeout_seconds} seconds." >&2
                    exit 1
                  fi
                  sleep 5
                done
                echo "Docker daemon is responsive."

                # Setup environment
                cd /workspace/go/src/github.com/pingcap/tidb-operator
                ./hack/e2e-patch-codecov.sh || true
                unset GOSUMDB
                E2E=y make build e2e-build
                make gocovmerge || true

                GITHASH=$(git rev-parse HEAD)
                IMAGE_TAG="e2e-${GITHASH:0:6}"

                echo "Building images locally..."
                E2E=y DOCKER_REPO=tidb-operator-e2e IMAGE_TAG=${IMAGE_TAG} make docker e2e-docker

                mount --make-rshared / || true
                mkdir -p /kind-data/control-plane/coverage
                mkdir -p /kind-data/worker1/coverage
                mkdir -p /kind-data/worker2/coverage
                mkdir -p /kind-data/worker3/coverage
                mkdir -p /mnt/tmpfs/etcd

                # Create kind cluster
                PROVIDER=kind KIND_DATA_HOSTPATH=/kind-data KIND_ETCD_DATADIR=/mnt/tmpfs/etcd SKIP_BUILD=y SKIP_IMAGE_BUILD=y SKIP_TEST=y SKIP_DOWN=y ./hack/e2e.sh

                test -f /root/.kube/config || { echo "ERROR: /root/.kube/config not found"; exit 1; }
                install -d -m 0755 /kubeconfig
                install -m 0644 /root/.kube/config /kubeconfig/admin.conf
                export KUBECONFIG=/kubeconfig/admin.conf

                echo "Creating coverage directories in kind nodes..."
                docker exec tidb-operator-control-plane mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker2 mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker3 mkdir -p /mnt/disks/coverage || true

                KIND_BIN="kind"
                if ! command -v kind >/dev/null 2>&1; then
                  KIND_VERSION="v0.19.0"
                  curl -fsSL "https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-amd64" -o /usr/local/bin/kind
                  chmod +x /usr/local/bin/kind
                  KIND_BIN="/usr/local/bin/kind"
                fi
                echo "Loading images into kind cluster..."
                for img in $(docker images --format "{{.Repository}}:{{.Tag}}" | grep "tidb-operator-e2e/.*:${IMAGE_TAG}$"); do
                  "${KIND_BIN}" load docker-image "${img}" --name tidb-operator || { echo "Failed to load ${img} into kind"; exit 1; }
                done

                docker update tidb-operator-control-plane --memory-reservation=6G -c 4096
                docker update tidb-operator-worker -m 16G --memory-swap 16G -c 4096
                docker update tidb-operator-worker2 -m 16G --memory-swap 16G -c 4096
                docker update tidb-operator-worker3 -m 16G --memory-swap 16G -c 4096

                echo "Run tests..."
                export GINKGO_NO_COLOR=y
                export DELETE_NAMESPACE_ON_FAILURE=false
                export ARTIFACTS=/workspace/go/src/github.com/pingcap/tidb-operator/_artifacts
                mkdir -p ${ARTIFACTS}

                timeout 7200 env \
                  E2E=y \
                  SKIP_BUILD=y \
                  SKIP_IMAGE_BUILD=y \
                  SKIP_UP=y \
                  SKIP_DOWN=y \
                  SKIP_IMAGE_LOAD=y \
                  KUBECONFIG=/kubeconfig/admin.conf \
                  DOCKER_REPO=tidb-operator-e2e \
                  IMAGE_TAG=${IMAGE_TAG} \
                  KIND_DATA_HOSTPATH=/kind-data \
                  KIND_ETCD_DATADIR=/mnt/tmpfs/etcd \
                  DELETE_NAMESPACE_ON_FAILURE=false \
                  GINKGO_NO_COLOR=y \
                  GINKGO_NODES=2 \
                  ./hack/e2e.sh -- --ginkgo.focus='\[TiDBCluster:\sBasic\]' --install-dm-mysql=false || {
                  EXIT_CODE=$?
                  
                  if [ $EXIT_CODE -eq 124 ]; then
                    echo "ERROR: Test execution timed out after 2 hours"
                  else
                    echo "ERROR: Test execution failed with exit code $EXIT_CODE"
                  fi
                  
                  exit $EXIT_CODE
                }

                echo "Merging coverage files..."
                mkdir -p /tmp/coverage-merge
                cp /kind-data/control-plane/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker1/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker2/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker3/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                
                if [ -n "$(ls -A /tmp/coverage-merge/*.cov 2>/dev/null)" ]; then
                  echo "Merging coverage files..."
                  ./bin/gocovmerge /tmp/coverage-merge/*.cov > ${ARTIFACTS}/coverage.txt || true
                  echo "Coverage merge completed"
                  if [ -f ${ARTIFACTS}/coverage.txt ] && [ -n "${CODECOV_TOKEN:-}" ]; then
                    echo "Uploading coverage to codecov..."
                    GIT_COMMIT=$(git rev-parse HEAD)
                    curl -fsSL https://codecov.io/bash -o /tmp/codecov.sh
                    bash /tmp/codecov.sh -t ${CODECOV_TOKEN} -F e2e -n tidb-operator -f ${ARTIFACTS}/coverage.txt -C ${GIT_COMMIT} || true
                  else
                    echo "Skipping coverage upload (file not found or token not set)"
                  fi
                else
                  echo "No coverage files found, skipping merge and upload"
                fi

                echo "Test execution completed"
            env:
              - name: ARTIFACTS
                value: /workspace/go/src/github.com/pingcap/tidb-operator/_artifacts
              - name: CODECOV_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: codecov-tokens
                    key: pingcap-tidb-operator
            volumeMounts:
              - name: docker-sock-dir
                mountPath: /var/run
              - name: data
                mountPath: /data
                subPath: data
              - name: modules
                mountPath: /lib/modules
                readOnly: true
              - name: cgroup
                mountPath: /sys/fs/cgroup
              - name: kubeconfig
                mountPath: /kubeconfig
              - name: kind-data
                mountPath: /kind-data
            resources:
              requests:
                memory: 24Gi
                cpu: "3"
              limits:
                memory: 24Gi
                cpu: "3"

    - name: pull-e2e-kind-br
      decorate: true
      decoration_config: *decoration_config
      skip_if_only_changed: *skip_if_only_changed
      branches: *e2e_kind_branches
      always_run: false
      optional: true
      trigger: "(?m)^/(run-all-tests$|run-pull-e2e-kind-br(\\s.*|$)|run-e2e-tests$|retest$)"
      rerun_command: "/run-pull-e2e-kind-br"
      spec:
        volumes:
          - name: docker-sock-dir
            emptyDir: {}
          - name: data
            ephemeral:
              volumeClaimTemplate:
                metadata:
                  labels:
                    type: ephemeral
                spec:
                  accessModes: ["ReadWriteOnce"]
                  storageClassName: "standard-rwo"
                  resources:
                    requests:
                      storage: 250Gi
          - name: modules
            hostPath:
              path: /lib/modules
              type: Directory
          - name: cgroup
            hostPath:
              path: /sys/fs/cgroup
              type: Directory
          - name: kubeconfig
            emptyDir: {}
          - name: kind-data
            emptyDir: {}
        initContainers:
          - name: dind-daemon
            image: docker:28.1-dind
            restartPolicy: Always
            command:
            - /bin/sh
            - -c
            - "dockerd-entrypoint.sh --cgroup-parent /kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod$(echo ${POD_UID} | tr - _).slice"
            env:
            - name: DOCKER_TLS_CERTDIR
              value: ""
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            securityContext:
              privileged: true
            volumeMounts:
              - name: docker-sock-dir
                mountPath: /var/run
              - name: data
                mountPath: /var/lib/docker
                subPath: docker
              - name: modules
                mountPath: /lib/modules
                readOnly: true
              - name: cgroup
                mountPath: /sys/fs/cgroup
              - name: kubeconfig
                mountPath: /kubeconfig
              - name: kind-data
                mountPath: /kind-data
            resources:
              requests:
                memory: "64Gi"
                cpu: "16"
              limits:
                memory: "64Gi"
                cpu: "16"
        containers:
          - name: e2e-runner
            image: ubuntu:22.04
            command: ["bash", "-ce"]
            args:
              - |
                #!/usr/bin/env bash
                set -ex
                export DEBIAN_FRONTEND=noninteractive
                apt-get update
                apt-get install -y --no-install-recommends \
                  ca-certificates \
                  curl \
                  git \
                  make \
                  cmake \
                  tar \
                  jq \
                  coreutils

                install -m 0755 -d /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
                chmod a+r /etc/apt/keyrings/docker.asc
                echo \
                  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
                  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
                  tee /etc/apt/sources.list.d/docker.list > /dev/null
                apt-get update
                apt-get install -y --no-install-recommends docker-ce-cli docker-buildx-plugin

                curl -fsSL https://go.dev/dl/go1.23.10.linux-amd64.tar.gz | tar -C /usr/local -xz
                export PATH=/usr/local/go/bin:$PATH
                export GOPATH=/go
                export GOCACHE=/tmp/go-cache

                echo "Waiting for Docker daemon..."
                timeout_seconds=120
                start_time=$(date +%s)
                while ! docker info > /dev/null 2>&1; do
                  current_time=$(date +%s)
                  elapsed=$((current_time - start_time))
                  if [ $elapsed -ge $timeout_seconds ]; then
                    echo "Error: Docker daemon did not start within ${timeout_seconds} seconds." >&2
                    exit 1
                  fi
                  sleep 5
                done
                echo "Docker daemon is responsive."

                cd /workspace/go/src/github.com/pingcap/tidb-operator
                ./hack/e2e-patch-codecov.sh || true
                unset GOSUMDB
                E2E=y make build e2e-build
                make gocovmerge || true

                GITHASH=$(git rev-parse HEAD)
                IMAGE_TAG="e2e-${GITHASH:0:6}"

                echo "Building images locally..."
                E2E=y DOCKER_REPO=tidb-operator-e2e IMAGE_TAG=${IMAGE_TAG} make docker e2e-docker

                mount --make-rshared / || true
                mkdir -p /kind-data/control-plane/coverage
                mkdir -p /kind-data/worker1/coverage
                mkdir -p /kind-data/worker2/coverage
                mkdir -p /kind-data/worker3/coverage
                mkdir -p /mnt/tmpfs/etcd

                PROVIDER=kind KIND_DATA_HOSTPATH=/kind-data KIND_ETCD_DATADIR=/mnt/tmpfs/etcd SKIP_BUILD=y SKIP_IMAGE_BUILD=y SKIP_TEST=y SKIP_DOWN=y ./hack/e2e.sh

                test -f /root/.kube/config || { echo "ERROR: /root/.kube/config not found"; exit 1; }
                install -d -m 0755 /kubeconfig
                install -m 0644 /root/.kube/config /kubeconfig/admin.conf
                export KUBECONFIG=/kubeconfig/admin.conf

                echo "Creating coverage directories in kind nodes..."
                docker exec tidb-operator-control-plane mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker2 mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker3 mkdir -p /mnt/disks/coverage || true

                KIND_BIN="kind"
                if ! command -v kind >/dev/null 2>&1; then
                  KIND_VERSION="v0.19.0"
                  curl -fsSL "https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-amd64" -o /usr/local/bin/kind
                  chmod +x /usr/local/bin/kind
                  KIND_BIN="/usr/local/bin/kind"
                fi
                echo "Loading images into kind cluster..."
                for img in $(docker images --format "{{.Repository}}:{{.Tag}}" | grep "tidb-operator-e2e/.*:${IMAGE_TAG}$"); do
                  "${KIND_BIN}" load docker-image "${img}" --name tidb-operator || { echo "Failed to load ${img} into kind"; exit 1; }
                done

                # Update kind node resources
                docker update tidb-operator-control-plane --memory-reservation=6G -c 8192
                docker update tidb-operator-worker -m 16G --memory-swap 16G -c 4096
                docker update tidb-operator-worker2 -m 16G --memory-swap 16G -c 4096
                docker update tidb-operator-worker3 -m 16G --memory-swap 16G -c 4096

                echo "Run tests..."
                export GINKGO_NO_COLOR=y
                export DELETE_NAMESPACE_ON_FAILURE=false
                export ARTIFACTS=/workspace/go/src/github.com/pingcap/tidb-operator/_artifacts
                mkdir -p ${ARTIFACTS}

                timeout 7200 env \
                  E2E=y \
                  SKIP_BUILD=y \
                  SKIP_IMAGE_BUILD=y \
                  SKIP_UP=y \
                  SKIP_DOWN=y \
                  SKIP_IMAGE_LOAD=y \
                  KUBECONFIG=/kubeconfig/admin.conf \
                  DOCKER_REPO=tidb-operator-e2e \
                  IMAGE_TAG=${IMAGE_TAG} \
                  KIND_DATA_HOSTPATH=/kind-data \
                  KIND_ETCD_DATADIR=/mnt/tmpfs/etcd \
                  DELETE_NAMESPACE_ON_FAILURE=false \
                  GINKGO_NO_COLOR=y \
                  GINKGO_NODES=3 \
                  ./hack/e2e.sh -- --ginkgo.focus='Backup\sand\sRestore' || {
                  EXIT_CODE=$?
                  
                  if [ $EXIT_CODE -eq 124 ]; then
                    echo "ERROR: Test execution timed out after 2 hours"
                  else
                    echo "ERROR: Test execution failed with exit code $EXIT_CODE"
                  fi
                  
                  exit $EXIT_CODE
                }

                echo "Merging coverage files..."
                mkdir -p /tmp/coverage-merge
                cp /kind-data/control-plane/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker1/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker2/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker3/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                
                if [ -n "$(ls -A /tmp/coverage-merge/*.cov 2>/dev/null)" ]; then
                  echo "Merging coverage files..."
                  ./bin/gocovmerge /tmp/coverage-merge/*.cov > ${ARTIFACTS}/coverage.txt || true
                  echo "Coverage merge completed"
                  if [ -f ${ARTIFACTS}/coverage.txt ] && [ -n "${CODECOV_TOKEN:-}" ]; then
                    echo "Uploading coverage to codecov..."
                    GIT_COMMIT=$(git rev-parse HEAD)
                    curl -fsSL https://codecov.io/bash -o /tmp/codecov.sh
                    bash /tmp/codecov.sh -t ${CODECOV_TOKEN} -F e2e -n tidb-operator -f ${ARTIFACTS}/coverage.txt -C ${GIT_COMMIT} || true
                  else
                    echo "Skipping coverage upload (file not found or token not set)"
                  fi
                else
                  echo "No coverage files found, skipping merge and upload"
                fi

                echo "Test execution completed"
            env:
              - name: ARTIFACTS
                value: /workspace/go/src/github.com/pingcap/tidb-operator/_artifacts
              - name: CODECOV_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: codecov-tokens
                    key: pingcap-tidb-operator
            volumeMounts:
              - name: docker-sock-dir
                mountPath: /var/run
              - name: data
                mountPath: /data
                subPath: data
              - name: modules
                mountPath: /lib/modules
                readOnly: true
              - name: cgroup
                mountPath: /sys/fs/cgroup
              - name: kubeconfig
                mountPath: /kubeconfig
              - name: kind-data
                mountPath: /kind-data
            resources:
              requests:
                memory: 24Gi
                cpu: "3"
              limits:
                memory: 24Gi
                cpu: "3"

    - name: pull-e2e-kind-across-kubernetes
      decorate: true
      decoration_config: *decoration_config
      skip_if_only_changed: *skip_if_only_changed
      branches: *e2e_kind_branches
      always_run: false
      optional: true
      trigger: "(?m)^/(run-all-tests$|run-pull-e2e-kind-across-kubernetes(\\s.*|$)|run-e2e-tests$|retest$)"
      rerun_command: "/run-pull-e2e-kind-across-kubernetes"
      spec:
        volumes:
          - name: docker-sock-dir
            emptyDir: {}
          - name: data
            ephemeral:
              volumeClaimTemplate:
                metadata:
                  labels:
                    type: ephemeral
                spec:
                  accessModes: ["ReadWriteOnce"]
                  storageClassName: "standard-rwo"
                  resources:
                    requests:
                      storage: 250Gi
          - name: modules
            hostPath:
              path: /lib/modules
              type: Directory
          - name: cgroup
            hostPath:
              path: /sys/fs/cgroup
              type: Directory
          - name: kubeconfig
            emptyDir: {}
          - name: kind-data
            emptyDir: {}
        initContainers:
          - name: dind-daemon
            image: docker:28.1-dind
            restartPolicy: Always
            command:
            - /bin/sh
            - -c
            - "dockerd-entrypoint.sh --cgroup-parent /kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod$(echo ${POD_UID} | tr - _).slice"
            env:
            - name: DOCKER_TLS_CERTDIR
              value: ""
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            securityContext:
              privileged: true
            volumeMounts:
              - name: docker-sock-dir
                mountPath: /var/run
              - name: data
                mountPath: /var/lib/docker
                subPath: docker
              - name: modules
                mountPath: /lib/modules
                readOnly: true
              - name: cgroup
                mountPath: /sys/fs/cgroup
              - name: kubeconfig
                mountPath: /kubeconfig
              - name: kind-data
                mountPath: /kind-data
            resources:
              requests:
                memory: "32Gi"
                cpu: "8"
              limits:
                memory: "32Gi"
                cpu: "8"
        containers:
          - name: e2e-runner
            image: ubuntu:22.04
            command: ["bash", "-ce"]
            args:
              - |
                #!/usr/bin/env bash
                set -ex
                export DEBIAN_FRONTEND=noninteractive
                apt-get update
                apt-get install -y --no-install-recommends \
                  ca-certificates \
                  curl \
                  git \
                  make \
                  cmake \
                  tar \
                  jq \
                  coreutils

                install -m 0755 -d /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
                chmod a+r /etc/apt/keyrings/docker.asc
                echo \
                  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
                  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
                  tee /etc/apt/sources.list.d/docker.list > /dev/null
                apt-get update
                apt-get install -y --no-install-recommends docker-ce-cli docker-buildx-plugin

                curl -fsSL https://go.dev/dl/go1.23.10.linux-amd64.tar.gz | tar -C /usr/local -xz
                export PATH=/usr/local/go/bin:$PATH
                export GOPATH=/go
                export GOCACHE=/tmp/go-cache

                echo "Waiting for Docker daemon..."
                timeout_seconds=120
                start_time=$(date +%s)
                while ! docker info > /dev/null 2>&1; do
                  current_time=$(date +%s)
                  elapsed=$((current_time - start_time))
                  if [ $elapsed -ge $timeout_seconds ]; then
                    echo "Error: Docker daemon did not start within ${timeout_seconds} seconds." >&2
                    exit 1
                  fi
                  sleep 5
                done
                echo "Docker daemon is responsive."

                cd /workspace/go/src/github.com/pingcap/tidb-operator
                ./hack/e2e-patch-codecov.sh || true
                unset GOSUMDB
                E2E=y make build e2e-build
                make gocovmerge || true

                GITHASH=$(git rev-parse HEAD)
                IMAGE_TAG="e2e-${GITHASH:0:6}"

                echo "Building images locally..."
                E2E=y DOCKER_REPO=tidb-operator-e2e IMAGE_TAG=${IMAGE_TAG} make docker e2e-docker

                mount --make-rshared / || true
                mkdir -p /kind-data/control-plane/coverage
                mkdir -p /kind-data/worker1/coverage
                mkdir -p /kind-data/worker2/coverage
                mkdir -p /kind-data/worker3/coverage
                mkdir -p /mnt/tmpfs/etcd

                PROVIDER=kind KIND_DATA_HOSTPATH=/kind-data KIND_ETCD_DATADIR=/mnt/tmpfs/etcd SKIP_BUILD=y SKIP_IMAGE_BUILD=y SKIP_TEST=y SKIP_DOWN=y ./hack/e2e.sh

                test -f /root/.kube/config || { echo "ERROR: /root/.kube/config not found"; exit 1; }
                install -d -m 0755 /kubeconfig
                install -m 0644 /root/.kube/config /kubeconfig/admin.conf
                export KUBECONFIG=/kubeconfig/admin.conf

                echo "Creating coverage directories in kind nodes..."
                docker exec tidb-operator-control-plane mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker2 mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker3 mkdir -p /mnt/disks/coverage || true

                KIND_BIN="kind"
                if ! command -v kind >/dev/null 2>&1; then
                  KIND_VERSION="v0.19.0"
                  curl -fsSL "https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-amd64" -o /usr/local/bin/kind
                  chmod +x /usr/local/bin/kind
                  KIND_BIN="/usr/local/bin/kind"
                fi
                echo "Loading images into kind cluster..."
                for img in $(docker images --format "{{.Repository}}:{{.Tag}}" | grep "tidb-operator-e2e/.*:${IMAGE_TAG}$"); do
                  "${KIND_BIN}" load docker-image "${img}" --name tidb-operator || { echo "Failed to load ${img} into kind"; exit 1; }
                done

                # Update kind node resources
                docker update tidb-operator-control-plane --memory-reservation=6G -c 4096
                docker update tidb-operator-worker -m 16G --memory-swap 16G -c 4096
                docker update tidb-operator-worker2 -m 16G --memory-swap 16G -c 4096
                docker update tidb-operator-worker3 -m 16G --memory-swap 16G -c 4096

                echo "Run tests..."
                export GINKGO_NO_COLOR=y
                export DELETE_NAMESPACE_ON_FAILURE=false
                export ARTIFACTS=/workspace/go/src/github.com/pingcap/tidb-operator/_artifacts
                mkdir -p ${ARTIFACTS}

                timeout 7200 env \
                  E2E=y \
                  SKIP_BUILD=y \
                  SKIP_IMAGE_BUILD=y \
                  SKIP_UP=y \
                  SKIP_DOWN=y \
                  SKIP_IMAGE_LOAD=y \
                  KUBECONFIG=/kubeconfig/admin.conf \
                  DOCKER_REPO=tidb-operator-e2e \
                  IMAGE_TAG=${IMAGE_TAG} \
                  KIND_DATA_HOSTPATH=/kind-data \
                  KIND_ETCD_DATADIR=/mnt/tmpfs/etcd \
                  DELETE_NAMESPACE_ON_FAILURE=false \
                  GINKGO_NO_COLOR=y \
                  GINKGO_NODES=2 \
                  ./hack/e2e.sh -- --ginkgo.focus='\[Across\sKubernetes\]' --install-dm-mysql=false || {
                  EXIT_CODE=$?
                  
                  if [ $EXIT_CODE -eq 124 ]; then
                    echo "ERROR: Test execution timed out after 2 hours"
                  else
                    echo "ERROR: Test execution failed with exit code $EXIT_CODE"
                  fi
                  
                  exit $EXIT_CODE
                }

                echo "Merging coverage files..."
                mkdir -p /tmp/coverage-merge
                cp /kind-data/control-plane/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker1/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker2/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker3/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                
                if [ -n "$(ls -A /tmp/coverage-merge/*.cov 2>/dev/null)" ]; then
                  echo "Merging coverage files..."
                  ./bin/gocovmerge /tmp/coverage-merge/*.cov > ${ARTIFACTS}/coverage.txt || true
                  echo "Coverage merge completed"
                else
                  echo "No coverage files found, skipping merge and upload"
                fi

                echo "Test execution completed"
            env:
              - name: ARTIFACTS
                value: /workspace/go/src/github.com/pingcap/tidb-operator/_artifacts
              - name: CODECOV_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: codecov-tokens
                    key: pingcap-tidb-operator
            volumeMounts:
              - name: docker-sock-dir
                mountPath: /var/run
              - name: data
                mountPath: /data
                subPath: data
              - name: modules
                mountPath: /lib/modules
                readOnly: true
              - name: cgroup
                mountPath: /sys/fs/cgroup
              - name: kubeconfig
                mountPath: /kubeconfig
              - name: kind-data
                mountPath: /kind-data
            resources:
              requests:
                memory: 24Gi
                cpu: "3"
              limits:
                memory: 24Gi
                cpu: "3"

    - name: pull-e2e-kind-scale-simultaneously
      decorate: true
      decoration_config: *decoration_config
      skip_if_only_changed: *skip_if_only_changed
      branches: *e2e_kind_branches
      always_run: false
      optional: true
      trigger: "(?m)^/(run-all-tests$|run-pull-e2e-kind-scale-simultaneously(\\s.*|$)|run-e2e-tests$|retest$)"
      rerun_command: "/run-pull-e2e-kind-scale-simultaneously"
      spec:
        volumes:
          - name: docker-sock-dir
            emptyDir: {}
          - name: data
            ephemeral:
              volumeClaimTemplate:
                metadata:
                  labels:
                    type: ephemeral
                spec:
                  accessModes: ["ReadWriteOnce"]
                  storageClassName: "standard-rwo"
                  resources:
                    requests:
                      storage: 250Gi
          - name: modules
            hostPath:
              path: /lib/modules
              type: Directory
          - name: cgroup
            hostPath:
              path: /sys/fs/cgroup
              type: Directory
          - name: kubeconfig
            emptyDir: {}
          - name: kind-data
            emptyDir: {}
        initContainers:
          - name: dind-daemon
            image: docker:28.1-dind
            restartPolicy: Always
            command:
            - /bin/sh
            - -c
            - "dockerd-entrypoint.sh --cgroup-parent /kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod$(echo ${POD_UID} | tr - _).slice"
            env:
            - name: DOCKER_TLS_CERTDIR
              value: ""
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            securityContext:
              privileged: true
            volumeMounts:
              - name: docker-sock-dir
                mountPath: /var/run
              - name: data
                mountPath: /var/lib/docker
                subPath: docker
              - name: modules
                mountPath: /lib/modules
                readOnly: true
              - name: cgroup
                mountPath: /sys/fs/cgroup
              - name: kubeconfig
                mountPath: /kubeconfig
              - name: kind-data
                mountPath: /kind-data
            resources:
              requests:
                memory: "64Gi"
                cpu: "16"
              limits:
                memory: "64Gi"
                cpu: "16"
        containers:
          - name: e2e-runner
            image: ubuntu:22.04
            command: ["bash", "-ce"]
            args:
              - |
                #!/usr/bin/env bash
                set -ex
                export DEBIAN_FRONTEND=noninteractive
                apt-get update
                apt-get install -y --no-install-recommends \
                  ca-certificates \
                  curl \
                  git \
                  make \
                  cmake \
                  tar \
                  jq \
                  coreutils

                install -m 0755 -d /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
                chmod a+r /etc/apt/keyrings/docker.asc
                echo \
                  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
                  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
                  tee /etc/apt/sources.list.d/docker.list > /dev/null
                apt-get update
                apt-get install -y --no-install-recommends docker-ce-cli docker-buildx-plugin

                curl -fsSL https://go.dev/dl/go1.23.10.linux-amd64.tar.gz | tar -C /usr/local -xz
                export PATH=/usr/local/go/bin:$PATH
                export GOPATH=/go
                export GOCACHE=/tmp/go-cache

                echo "Waiting for Docker daemon..."
                timeout_seconds=120
                start_time=$(date +%s)
                while ! docker info > /dev/null 2>&1; do
                  current_time=$(date +%s)
                  elapsed=$((current_time - start_time))
                  if [ $elapsed -ge $timeout_seconds ]; then
                    echo "Error: Docker daemon did not start within ${timeout_seconds} seconds." >&2
                    exit 1
                  fi
                  sleep 5
                done
                echo "Docker daemon is responsive."

                cd /workspace/go/src/github.com/pingcap/tidb-operator
                ./hack/e2e-patch-codecov.sh || true
                unset GOSUMDB
                E2E=y make build e2e-build
                make gocovmerge || true

                GITHASH=$(git rev-parse HEAD)
                IMAGE_TAG="e2e-${GITHASH:0:6}"

                echo "Building images locally..."
                E2E=y DOCKER_REPO=tidb-operator-e2e IMAGE_TAG=${IMAGE_TAG} make docker e2e-docker

                mount --make-rshared / || true
                mkdir -p /kind-data/control-plane/coverage
                mkdir -p /kind-data/worker1/coverage
                mkdir -p /kind-data/worker2/coverage
                mkdir -p /kind-data/worker3/coverage
                mkdir -p /mnt/tmpfs/etcd

                PROVIDER=kind KIND_DATA_HOSTPATH=/kind-data KIND_ETCD_DATADIR=/mnt/tmpfs/etcd SKIP_BUILD=y SKIP_IMAGE_BUILD=y SKIP_TEST=y SKIP_DOWN=y ./hack/e2e.sh

                test -f /root/.kube/config || { echo "ERROR: /root/.kube/config not found"; exit 1; }
                install -d -m 0755 /kubeconfig
                install -m 0644 /root/.kube/config /kubeconfig/admin.conf
                export KUBECONFIG=/kubeconfig/admin.conf

                echo "Creating coverage directories in kind nodes..."
                docker exec tidb-operator-control-plane mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker2 mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker3 mkdir -p /mnt/disks/coverage || true

                KIND_BIN="kind"
                if ! command -v kind >/dev/null 2>&1; then
                  KIND_VERSION="v0.19.0"
                  curl -fsSL "https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-amd64" -o /usr/local/bin/kind
                  chmod +x /usr/local/bin/kind
                  KIND_BIN="/usr/local/bin/kind"
                fi
                echo "Loading images into kind cluster..."
                for img in $(docker images --format "{{.Repository}}:{{.Tag}}" | grep "tidb-operator-e2e/.*:${IMAGE_TAG}$"); do
                  "${KIND_BIN}" load docker-image "${img}" --name tidb-operator || { echo "Failed to load ${img} into kind"; exit 1; }
                done

                # Update kind node resources
                docker update tidb-operator-control-plane --memory-reservation=6G -c 8192
                docker update tidb-operator-worker -m 16G --memory-swap 16G -c 4096
                docker update tidb-operator-worker2 -m 16G --memory-swap 16G -c 4096
                docker update tidb-operator-worker3 -m 16G --memory-swap 16G -c 4096

                echo "Run tests..."
                export GINKGO_NO_COLOR=y
                export DELETE_NAMESPACE_ON_FAILURE=false
                export ARTIFACTS=/workspace/go/src/github.com/pingcap/tidb-operator/_artifacts
                mkdir -p ${ARTIFACTS}

                timeout 7200 env \
                  E2E=y \
                  SKIP_BUILD=y \
                  SKIP_IMAGE_BUILD=y \
                  SKIP_UP=y \
                  SKIP_DOWN=y \
                  SKIP_IMAGE_LOAD=y \
                  KUBECONFIG=/kubeconfig/admin.conf \
                  DOCKER_REPO=tidb-operator-e2e \
                  IMAGE_TAG=${IMAGE_TAG} \
                  KIND_DATA_HOSTPATH=/kind-data \
                  KIND_ETCD_DATADIR=/mnt/tmpfs/etcd \
                  DELETE_NAMESPACE_ON_FAILURE=false \
                  GINKGO_NO_COLOR=y \
                  GINKGO_NODES=1 \
                  ./hack/e2e.sh -- --ginkgo.focus='Scale\sin\ssimultaneously' || {
                  EXIT_CODE=$?
                  
                  if [ $EXIT_CODE -eq 124 ]; then
                    echo "ERROR: Test execution timed out after 2 hours"
                  else
                    echo "ERROR: Test execution failed with exit code $EXIT_CODE"
                  fi
                  
                  exit $EXIT_CODE
                }

                echo "Merging coverage files..."
                mkdir -p /tmp/coverage-merge
                cp /kind-data/control-plane/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker1/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker2/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker3/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                
                if [ -n "$(ls -A /tmp/coverage-merge/*.cov 2>/dev/null)" ]; then
                  echo "Merging coverage files..."
                  ./bin/gocovmerge /tmp/coverage-merge/*.cov > ${ARTIFACTS}/coverage.txt || true
                  echo "Coverage merge completed"
                else
                  echo "No coverage files found, skipping merge and upload"
                fi

                echo "Test execution completed"
            env:
              - name: ARTIFACTS
                value: /workspace/go/src/github.com/pingcap/tidb-operator/_artifacts
              - name: CODECOV_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: codecov-tokens
                    key: pingcap-tidb-operator
            volumeMounts:
              - name: docker-sock-dir
                mountPath: /var/run
              - name: data
                mountPath: /data
                subPath: data
              - name: modules
                mountPath: /lib/modules
                readOnly: true
              - name: cgroup
                mountPath: /sys/fs/cgroup
              - name: kubeconfig
                mountPath: /kubeconfig
              - name: kind-data
                mountPath: /kind-data
            resources:
              requests:
                memory: 24Gi
                cpu: "3"
              limits:
                memory: 24Gi
                cpu: "3"

    - name: pull-e2e-kind-serial
      decorate: true
      decoration_config: *decoration_config
      skip_if_only_changed: *skip_if_only_changed
      branches: *e2e_kind_branches
      always_run: false
      optional: true
      trigger: "(?m)^/(run-all-tests$|run-pull-e2e-kind-serial(\\s.*|$)|run-e2e-tests$|retest$)"
      rerun_command: "/run-pull-e2e-kind-serial"
      spec:
        volumes:
          - name: docker-sock-dir
            emptyDir: {}
          - name: data
            ephemeral:
              volumeClaimTemplate:
                metadata:
                  labels:
                    type: ephemeral
                spec:
                  accessModes: ["ReadWriteOnce"]
                  storageClassName: "standard-rwo"
                  resources:
                    requests:
                      storage: 250Gi
          - name: modules
            hostPath:
              path: /lib/modules
              type: Directory
          - name: cgroup
            hostPath:
              path: /sys/fs/cgroup
              type: Directory
          - name: kubeconfig
            emptyDir: {}
          - name: kind-data
            emptyDir: {}
        initContainers:
          - name: dind-daemon
            image: docker:28.1-dind
            restartPolicy: Always
            command:
            - /bin/sh
            - -c
            - "dockerd-entrypoint.sh --cgroup-parent /kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod$(echo ${POD_UID} | tr - _).slice"
            env:
            - name: DOCKER_TLS_CERTDIR
              value: ""
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            securityContext:
              privileged: true
            volumeMounts:
              - name: docker-sock-dir
                mountPath: /var/run
              - name: data
                mountPath: /var/lib/docker
                subPath: docker
              - name: modules
                mountPath: /lib/modules
                readOnly: true
              - name: cgroup
                mountPath: /sys/fs/cgroup
              - name: kubeconfig
                mountPath: /kubeconfig
              - name: kind-data
                mountPath: /kind-data
            resources:
              requests:
                memory: "32Gi"
                cpu: "8"
              limits:
                memory: "32Gi"
                cpu: "8"
        containers:
          - name: e2e-runner
            image: ubuntu:22.04
            command: ["bash", "-ce"]
            args:
              - |
                #!/usr/bin/env bash
                set -ex
                export DEBIAN_FRONTEND=noninteractive
                apt-get update
                apt-get install -y --no-install-recommends \
                  ca-certificates \
                  curl \
                  git \
                  make \
                  cmake \
                  tar \
                  jq \
                  coreutils

                install -m 0755 -d /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
                chmod a+r /etc/apt/keyrings/docker.asc
                echo \
                  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
                  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
                  tee /etc/apt/sources.list.d/docker.list > /dev/null
                apt-get update
                apt-get install -y --no-install-recommends docker-ce-cli docker-buildx-plugin

                curl -fsSL https://go.dev/dl/go1.23.10.linux-amd64.tar.gz | tar -C /usr/local -xz
                export PATH=/usr/local/go/bin:$PATH
                export GOPATH=/go
                export GOCACHE=/tmp/go-cache

                echo "Waiting for Docker daemon..."
                timeout_seconds=120
                start_time=$(date +%s)
                while ! docker info > /dev/null 2>&1; do
                  current_time=$(date +%s)
                  elapsed=$((current_time - start_time))
                  if [ $elapsed -ge $timeout_seconds ]; then
                    echo "Error: Docker daemon did not start within ${timeout_seconds} seconds." >&2
                    exit 1
                  fi
                  sleep 5
                done
                echo "Docker daemon is responsive."

                cd /workspace/go/src/github.com/pingcap/tidb-operator
                ./hack/e2e-patch-codecov.sh || true
                unset GOSUMDB
                E2E=y make build e2e-build
                make gocovmerge || true

                GITHASH=$(git rev-parse HEAD)
                IMAGE_TAG="e2e-${GITHASH:0:6}"

                echo "Building images locally..."
                E2E=y DOCKER_REPO=tidb-operator-e2e IMAGE_TAG=${IMAGE_TAG} make docker e2e-docker

                mount --make-rshared / || true
                mkdir -p /kind-data/control-plane/coverage
                mkdir -p /kind-data/worker1/coverage
                mkdir -p /kind-data/worker2/coverage
                mkdir -p /kind-data/worker3/coverage
                mkdir -p /mnt/tmpfs/etcd

                PROVIDER=kind KIND_DATA_HOSTPATH=/kind-data KIND_ETCD_DATADIR=/mnt/tmpfs/etcd SKIP_BUILD=y SKIP_IMAGE_BUILD=y SKIP_TEST=y SKIP_DOWN=y ./hack/e2e.sh

                test -f /root/.kube/config || { echo "ERROR: /root/.kube/config not found"; exit 1; }
                install -d -m 0755 /kubeconfig
                install -m 0644 /root/.kube/config /kubeconfig/admin.conf
                export KUBECONFIG=/kubeconfig/admin.conf

                echo "Creating coverage directories in kind nodes..."
                docker exec tidb-operator-control-plane mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker2 mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker3 mkdir -p /mnt/disks/coverage || true

                KIND_BIN="kind"
                if ! command -v kind >/dev/null 2>&1; then
                  KIND_VERSION="v0.19.0"
                  curl -fsSL "https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-amd64" -o /usr/local/bin/kind
                  chmod +x /usr/local/bin/kind
                  KIND_BIN="/usr/local/bin/kind"
                fi
                echo "Loading images into kind cluster..."
                for img in $(docker images --format "{{.Repository}}:{{.Tag}}" | grep "tidb-operator-e2e/.*:${IMAGE_TAG}$"); do
                  "${KIND_BIN}" load docker-image "${img}" --name tidb-operator || { echo "Failed to load ${img} into kind"; exit 1; }
                done

                # Update kind node resources
                docker update tidb-operator-control-plane --memory-reservation=6G -c 4096
                docker update tidb-operator-worker -m 16G --memory-swap 16G -c 4096
                docker update tidb-operator-worker2 -m 16G --memory-swap 16G -c 4096
                docker update tidb-operator-worker3 -m 16G --memory-swap 16G -c 4096

                echo "Run tests..."
                export GINKGO_NO_COLOR=y
                export DELETE_NAMESPACE_ON_FAILURE=true
                export ARTIFACTS=/workspace/go/src/github.com/pingcap/tidb-operator/_artifacts
                mkdir -p ${ARTIFACTS}

                timeout 7200 env \
                  E2E=y \
                  SKIP_BUILD=y \
                  SKIP_IMAGE_BUILD=y \
                  SKIP_UP=y \
                  SKIP_DOWN=y \
                  SKIP_IMAGE_LOAD=y \
                  KUBECONFIG=/kubeconfig/admin.conf \
                  DOCKER_REPO=tidb-operator-e2e \
                  IMAGE_TAG=${IMAGE_TAG} \
                  KIND_DATA_HOSTPATH=/kind-data \
                  KIND_ETCD_DATADIR=/mnt/tmpfs/etcd \
                  DELETE_NAMESPACE_ON_FAILURE=true \
                  GINKGO_NO_COLOR=y \
                  GINKGO_NODES=1 \
                  ./hack/e2e.sh -- --ginkgo.focus='\[Serial\]' --install-operator=false || {
                  EXIT_CODE=$?
                  
                  if [ $EXIT_CODE -eq 124 ]; then
                    echo "ERROR: Test execution timed out after 2 hours"
                  else
                    echo "ERROR: Test execution failed with exit code $EXIT_CODE"
                  fi
                  
                  exit $EXIT_CODE
                }

                echo "Merging coverage files..."
                mkdir -p /tmp/coverage-merge
                cp /kind-data/control-plane/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker1/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker2/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker3/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                
                if [ -n "$(ls -A /tmp/coverage-merge/*.cov 2>/dev/null)" ]; then
                  echo "Merging coverage files..."
                  ./bin/gocovmerge /tmp/coverage-merge/*.cov > ${ARTIFACTS}/coverage.txt || true
                  echo "Coverage merge completed"
                else
                  echo "No coverage files found, skipping merge and upload"
                fi

                echo "Test execution completed"
            env:
              - name: ARTIFACTS
                value: /workspace/go/src/github.com/pingcap/tidb-operator/_artifacts
              - name: CODECOV_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: codecov-tokens
                    key: pingcap-tidb-operator
            volumeMounts:
              - name: docker-sock-dir
                mountPath: /var/run
              - name: data
                mountPath: /data
                subPath: data
              - name: modules
                mountPath: /lib/modules
                readOnly: true
              - name: cgroup
                mountPath: /sys/fs/cgroup
              - name: kubeconfig
                mountPath: /kubeconfig
              - name: kind-data
                mountPath: /kind-data
            resources:
              requests:
                memory: 24Gi
                cpu: "3"
              limits:
                memory: 24Gi
                cpu: "3"

    - name: pull-e2e-kind-tngm
      decorate: true
      decoration_config: *decoration_config
      skip_if_only_changed: *skip_if_only_changed
      branches: *e2e_kind_branches
      always_run: false
      optional: true
      trigger: "(?m)^/(run-all-tests$|run-pull-e2e-kind-tngm(\\s.*|$)|run-e2e-tests$|retest$)"
      rerun_command: "/run-pull-e2e-kind-tngm"
      spec:
        volumes:
          - name: docker-sock-dir
            emptyDir: {}
          - name: data
            ephemeral:
              volumeClaimTemplate:
                metadata:
                  labels:
                    type: ephemeral
                spec:
                  accessModes: ["ReadWriteOnce"]
                  storageClassName: "standard-rwo"
                  resources:
                    requests:
                      storage: 250Gi
          - name: modules
            hostPath:
              path: /lib/modules
              type: Directory
          - name: cgroup
            hostPath:
              path: /sys/fs/cgroup
              type: Directory
          - name: kubeconfig
            emptyDir: {}
          - name: kind-data
            emptyDir: {}
        initContainers:
          - name: dind-daemon
            image: docker:28.1-dind
            restartPolicy: Always
            command:
            - /bin/sh
            - -c
            - "dockerd-entrypoint.sh --cgroup-parent /kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod$(echo ${POD_UID} | tr - _).slice"
            env:
            - name: DOCKER_TLS_CERTDIR
              value: ""
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            securityContext:
              privileged: true
            volumeMounts:
              - name: docker-sock-dir
                mountPath: /var/run
              - name: data
                mountPath: /var/lib/docker
                subPath: docker
              - name: modules
                mountPath: /lib/modules
                readOnly: true
              - name: cgroup
                mountPath: /sys/fs/cgroup
              - name: kubeconfig
                mountPath: /kubeconfig
              - name: kind-data
                mountPath: /kind-data
            resources:
              requests:
                memory: "32Gi"
                cpu: "8"
              limits:
                memory: "32Gi"
                cpu: "8"
        containers:
          - name: e2e-runner
            image: ubuntu:22.04
            command: ["bash", "-ce"]
            args:
              - |
                #!/usr/bin/env bash
                set -ex
                export DEBIAN_FRONTEND=noninteractive
                apt-get update
                apt-get install -y --no-install-recommends \
                  ca-certificates \
                  curl \
                  git \
                  make \
                  cmake \
                  tar \
                  jq \
                  coreutils

                install -m 0755 -d /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
                chmod a+r /etc/apt/keyrings/docker.asc
                echo \
                  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
                  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
                  tee /etc/apt/sources.list.d/docker.list > /dev/null
                apt-get update
                apt-get install -y --no-install-recommends docker-ce-cli docker-buildx-plugin

                curl -fsSL https://go.dev/dl/go1.23.10.linux-amd64.tar.gz | tar -C /usr/local -xz
                export PATH=/usr/local/go/bin:$PATH
                export GOPATH=/go
                export GOCACHE=/tmp/go-cache

                echo "Waiting for Docker daemon..."
                timeout_seconds=120
                start_time=$(date +%s)
                while ! docker info > /dev/null 2>&1; do
                  current_time=$(date +%s)
                  elapsed=$((current_time - start_time))
                  if [ $elapsed -ge $timeout_seconds ]; then
                    echo "Error: Docker daemon did not start within ${timeout_seconds} seconds." >&2
                    exit 1
                  fi
                  sleep 5
                done
                echo "Docker daemon is responsive."

                cd /workspace/go/src/github.com/pingcap/tidb-operator
                ./hack/e2e-patch-codecov.sh || true
                unset GOSUMDB
                E2E=y make build e2e-build
                make gocovmerge || true

                GITHASH=$(git rev-parse HEAD)
                IMAGE_TAG="e2e-${GITHASH:0:6}"

                echo "Building images locally..."
                E2E=y DOCKER_REPO=tidb-operator-e2e IMAGE_TAG=${IMAGE_TAG} make docker e2e-docker

                mount --make-rshared / || true
                mkdir -p /kind-data/control-plane/coverage
                mkdir -p /kind-data/worker1/coverage
                mkdir -p /kind-data/worker2/coverage
                mkdir -p /kind-data/worker3/coverage
                mkdir -p /mnt/tmpfs/etcd

                PROVIDER=kind KIND_DATA_HOSTPATH=/kind-data KIND_ETCD_DATADIR=/mnt/tmpfs/etcd SKIP_BUILD=y SKIP_IMAGE_BUILD=y SKIP_TEST=y SKIP_DOWN=y ./hack/e2e.sh

                test -f /root/.kube/config || { echo "ERROR: /root/.kube/config not found"; exit 1; }
                install -d -m 0755 /kubeconfig
                install -m 0644 /root/.kube/config /kubeconfig/admin.conf
                export KUBECONFIG=/kubeconfig/admin.conf

                echo "Creating coverage directories in kind nodes..."
                docker exec tidb-operator-control-plane mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker2 mkdir -p /mnt/disks/coverage || true
                docker exec tidb-operator-worker3 mkdir -p /mnt/disks/coverage || true

                KIND_BIN="kind"
                if ! command -v kind >/dev/null 2>&1; then
                  KIND_VERSION="v0.19.0"
                  curl -fsSL "https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-amd64" -o /usr/local/bin/kind
                  chmod +x /usr/local/bin/kind
                  KIND_BIN="/usr/local/bin/kind"
                fi
                echo "Loading images into kind cluster..."
                for img in $(docker images --format "{{.Repository}}:{{.Tag}}" | grep "tidb-operator-e2e/.*:${IMAGE_TAG}$"); do
                  "${KIND_BIN}" load docker-image "${img}" --name tidb-operator || { echo "Failed to load ${img} into kind"; exit 1; }
                done

                # Update kind node resources
                docker update tidb-operator-control-plane --memory-reservation=6G -c 4096
                docker update tidb-operator-worker -m 16G --memory-swap 16G -c 4096
                docker update tidb-operator-worker2 -m 16G --memory-swap 16G -c 4096
                docker update tidb-operator-worker3 -m 16G --memory-swap 16G -c 4096

                echo "Run tests..."
                export GINKGO_NO_COLOR=y
                export DELETE_NAMESPACE_ON_FAILURE=false
                export ARTIFACTS=/workspace/go/src/github.com/pingcap/tidb-operator/_artifacts
                mkdir -p ${ARTIFACTS}

                timeout 7200 env \
                  E2E=y \
                  SKIP_BUILD=y \
                  SKIP_IMAGE_BUILD=y \
                  SKIP_UP=y \
                  SKIP_DOWN=y \
                  SKIP_IMAGE_LOAD=y \
                  KUBECONFIG=/kubeconfig/admin.conf \
                  DOCKER_REPO=tidb-operator-e2e \
                  IMAGE_TAG=${IMAGE_TAG} \
                  KIND_DATA_HOSTPATH=/kind-data \
                  KIND_ETCD_DATADIR=/mnt/tmpfs/etcd \
                  DELETE_NAMESPACE_ON_FAILURE=false \
                  GINKGO_NO_COLOR=y \
                  GINKGO_NODES=1 \
                  ./hack/e2e.sh -- --ginkgo.focus='TiDBNGMonitoring' || {
                  EXIT_CODE=$?
                  
                  if [ $EXIT_CODE -eq 124 ]; then
                    echo "ERROR: Test execution timed out after 2 hours"
                  else
                    echo "ERROR: Test execution failed with exit code $EXIT_CODE"
                  fi
                  
                  exit $EXIT_CODE
                }

                echo "Merging coverage files..."
                mkdir -p /tmp/coverage-merge
                cp /kind-data/control-plane/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker1/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker2/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                cp /kind-data/worker3/coverage/*.cov /tmp/coverage-merge/ 2>/dev/null || true
                
                if [ -n "$(ls -A /tmp/coverage-merge/*.cov 2>/dev/null)" ]; then
                  echo "Merging coverage files..."
                  ./bin/gocovmerge /tmp/coverage-merge/*.cov > ${ARTIFACTS}/coverage.txt || true
                  echo "Coverage merge completed"
                else
                  echo "No coverage files found, skipping merge and upload"
                fi

                echo "Test execution completed"
            env:
              - name: ARTIFACTS
                value: /workspace/go/src/github.com/pingcap/tidb-operator/_artifacts
              - name: CODECOV_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: codecov-tokens
                    key: pingcap-tidb-operator
            volumeMounts:
              - name: docker-sock-dir
                mountPath: /var/run
              - name: data
                mountPath: /data
                subPath: data
              - name: modules
                mountPath: /lib/modules
                readOnly: true
              - name: cgroup
                mountPath: /sys/fs/cgroup
              - name: kubeconfig
                mountPath: /kubeconfig
              - name: kind-data
                mountPath: /kind-data
            resources:
              requests:
                memory: 24Gi
                cpu: "3"
              limits:
                memory: 24Gi
                cpu: "3"
