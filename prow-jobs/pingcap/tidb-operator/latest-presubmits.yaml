global_definitions:
  branches: &branches
    - ^feature/v2$
  skip_if_only_changed: &skip_if_only_changed
    "(\\.(md|png|jpeg|jpg|gif|svg|pdf)|Dockerfile|OWNERS|OWNERS_ALIASES)$"
  decoration_config: &decoration_config
    timeout: 45m


# struct ref: https://pkg.go.dev/sigs.k8s.io/prow/pkg/config#Presubmit
presubmits:
  pingcap/tidb-operator:
    - name: pull-e2e
      decorate: true # need add this.
      decoration_config: *decoration_config
      always_run: false
      optional: true
      # skip_if_only_changed: *skip_if_only_changed
      branches: *branches
      spec:
        containers:
          - name: e2e
            image: docker:28.1-dind-rootless
            command: [bash, -ce]
            args:
              - |
                set -e
                # Start rootless Docker daemon
                echo "Starting dockerd-rootless.sh..."
                dockerd-rootless.sh &
                
                # Wait for Docker to start.
                echo "Waiting for Docker to start..."
                timeout 60s sh -c 'until docker info > /dev/null 2>&1; do echo "Waiting for Docker to start $(date)..."; sleep 1; done'
                echo "Docker started."

                # Run the original command
                make e2e
            securityContext:
              privileged: true
              runAsUser: 1001
              runAsGroup: 1001
            resources:
              requests:
                memory: 32Gi
                cpu: "8"
              limits:
                memory: 32Gi
                cpu: "8"
