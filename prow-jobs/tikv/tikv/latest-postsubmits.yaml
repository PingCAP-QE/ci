# struct ref: https://pkg.go.dev/sigs.k8s.io/prow/pkg/config#Postsubmit
postsubmits:
  tikv/tikv:
    - name: unit-test-coverage
      cluster: default
      decorate: true
      branches:
        - ^master$
      max_concurrency: 1
      spec:
        containers:
          - name: coverage
            image: ghcr.io/pingcap-qe/ci/base:v2025.12.7-10-gf44bb75-go1.25
            command: [bash, -ce]
            args:
              - |
                #!/usr/bin/env bash
                set -euo pipefail

                yum install -y cmake perl-CPAN perl-devel gcc-c++ glibc-devel || true

                rustup component add llvm-tools-preview

                NEXTEST_VERSION="0.9.109"
                ARCH=$(uname -m)
                case "$ARCH" in
                  x86_64)
                    NEXTEST_ARCH="x86_64-unknown-linux-gnu"
                    CODECOV_ARCH="linux"
                    ;;
                  aarch64|arm64)
                    NEXTEST_ARCH="aarch64-unknown-linux-gnu"
                    CODECOV_ARCH="aarch64"
                    ;;
                  *)
                    echo "Unsupported architecture: $ARCH" >&2
                    exit 1
                    ;;
                esac
                NEXTEST_TARBALL="cargo-nextest-${NEXTEST_VERSION}-${NEXTEST_ARCH}.tar.gz"
                NEXTEST_URL="https://github.com/nextest-rs/nextest/releases/download/cargo-nextest-${NEXTEST_VERSION}/${NEXTEST_TARBALL}"

                curl -LO "${NEXTEST_URL}"
                tar xzvf "${NEXTEST_TARBALL}"
                chmod +x cargo-nextest
                mv cargo-nextest /usr/local/bin/
                cargo-nextest --version

                if ! command -v grcov >/dev/null 2>&1; then
                  cargo install --locked grcov --git https://github.com/glorv/grcov --branch patched
                fi
                grcov --version

                curl -fsSL https://uploader.codecov.io/latest/${CODECOV_ARCH}/codecov -o codecov
                chmod +x codecov

                export FAIL_POINT=1
                export ROCKSDB_SYS_SSE=1
                export CARGO_INCREMENTAL=0
                export RUSTFLAGS="-C instrument-coverage"
                export NEXTEST_PROFILE=ci
                export CUSTOM_TEST_COMMAND="nextest run --test-threads 6"

                if [ -f /opt/rh/devtoolset-8/enable ]; then
                  echo "using devtoolset-8 (gcc 8)"
                  # shellcheck disable=SC1091
                  source /opt/rh/devtoolset-8/enable
                fi

                set +e
                LLVM_PROFILE_FILE="/mnt/profraw/tikv-%p-%m.profraw" \
                EXTRA_CARGO_ARGS=--no-fail-fast \
                make test_with_nextest
                TEST_RC=$?
                set -e
                if [ ${TEST_RC} -ne 0 ]; then
                  echo "tests failed (rc=${TEST_RC}), continue to generate coverage anyway"
                fi

                grcov /mnt/profraw/ \
                  --binary-path ./target/debug/ \
                  -s . \
                  -t lcov \
                  --branch \
                  --ignore-not-existing \
                  --ignore "target/debug/*" \
                  --ignore "**/.cargo/**" \
                  --ignore "**/cargo/**" \
                  --ignore "**/target/debug/deps/**" \
                  --ignore "**/target/debug/build/**" \
                  -o lcov.info

                  UPLOAD_RC=0
                  if ./codecov -f lcov.info -C "${PULL_BASE_SHA}" -B "$PULL_BASE_REF" -r "tikv/tikv" -Z; then
                    echo "Coverage report uploaded successfully to codecov.io"
                  else
                    echo "Codecov upload failed..."
                    UPLOAD_RC=1
                  fi

                  if [ ${TEST_RC} -ne 0 ]; then
                    echo "Task failed: Tests failed (exit code: ${TEST_RC})"
                    exit ${TEST_RC}
                  else
                    echo "Task succeeded: All tests passed"
                    if [ ${UPLOAD_RC} -ne 0 ]; then
                      echo "Warning: Coverage upload failed, but tests passed"
                    fi
                    exit ${UPLOAD_RC}
                  fi
            env:
              - name: CODECOV_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: codecov-tokens
                    key: tikv-tikv
            volumeMounts:
              - name: profraw-storage
                mountPath: /mnt/profraw
            resources:
              requests:
                cpu: "6"
                memory: 16Gi
              limits:
                cpu: "6"
                memory: 16Gi
        volumes:
          - name: profraw-storage
            ephemeral:
              volumeClaimTemplate:
                spec:
                  accessModes: ["ReadWriteOnce"]
                  storageClassName: "hyperdisk-rwo"
                  resources:
                    requests:
                      storage: 100Gi
