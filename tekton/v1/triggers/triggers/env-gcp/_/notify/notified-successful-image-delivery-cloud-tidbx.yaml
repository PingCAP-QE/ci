apiVersion: triggers.tekton.dev/v1beta1
kind: Trigger
metadata:
  name: notified-successful-image-delivery-cloud-tidbx
  labels:
    type: github-issue-comment
spec:
  interceptors:
    - name: filter on github repo and comment content
      ref: { name: cel }
      params:
        - name: filter
          value: >-
            body.comment.body.matches('<!--\\s*META={.+?\\s*-->')
            &&
            size(body.comment.body.split('<!--')[1].split('-->')[0].replace('META=', '').parseJSON().images) > 0
        - name: overlays
          value:
            - key: images
              expression: body.comment.body.split('<!--')[1].split('-->')[0].replace('META=', '').parseJSON().images.marshalJSON()
            - key: target_images
              expression: body.comment.body.split('<!--')[1].split('-->')[0].replace('META=', '').parseJSON().target_images.marshalJSON()
            - key: stage
              expression: body.comment.body.split('<!--')[1].split('-->')[0].replace('META=', '').parseJSON().stage

  bindings:
    - ref: github-issue-comment
    - { name: images, value: $(extensions.images) }
    - { name: target_images, value: $(extensions.target_images) }
    - { name: stage, value: $(extensions.stage) }
  template:
    spec:
      params:
        - name: images
        - name: target_images
        - name: stage
      resourceTemplates:
        - apiVersion: tekton.dev/v1
          kind: TaskRun
          metadata:
            generateName: pingcap-notify-to-deliver-images-to-cloud-tidbx-
          spec:
            taskRef:
              name: pingcap-notify-to-update-ops-tidbx
            params:
              - name: images
                value: $(tt.params.images)
              - name: target_images
                value: $(tt.params.target_images)
              - name: stage
                value: $(tt.params.stage)
            workspaces:
              - name: notify-config
                secret:
                  secretName: image-delivery-notify-config-tidbx
              - name: ops-config
                secret:
                  secretName: image-delivery-ops-config-tidbx
        - apiVersion: tekton.dev/v1
          kind: TaskRun
          metadata:
            generateName: pingcap-notify-to-add-image-records-to-tcms-
          spec:
            taskRef:
              name: pingcap-notify-to-update-tcms-tidbx
            params:
              - name: images
                value: $(tt.params.images)
