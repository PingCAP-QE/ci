# yaml-language-server: $schema=https://github.com/redhat-developer/vscode-tekton/raw/refs/heads/main/scheme/tekton.dev/v1_Task.json
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: pingcap-notify-for-tidbx-images
  labels:
    app.kubernetes.io/version: "0.1.0"
  annotations:
    tekton.dev/pipelines.minVersion: "1.0.0"
    tekton.dev/categories: delivery
    tekton.dev/tags: images,delivery
    tekton.dev/displayName: "PingCAP product Ops delivery"
    tekton.dev/platforms: "linux/amd64,linux/arm64"
spec:
  params:
    - name: src
      description: images list
  workspaces:
    - name: notify-config
      description: |
        Configuration for GitHub authentication and issue URLs.
        Include files:
        - GitHub token: <stage>_github_token
        - GitHub issue URL: <stage>_github_issue_url
      readOnly: true
  stepTemplate:
    image: ghcr.io/pingcap-qe/cd/utils/release:v2025.10.26-5-ge8130cb
  steps:
    - name: notify-to-sync-images
      script: |
        #!/usr/bin/env bash
        set -e

        cat > images.yaml <<'EOF'
        $(params.src)
        EOF

        for stage in dev prod; do
          github_issue_url="$(cat $(workspaces.notify-config.path)/${stage}_github_issue_url)"
          gh auth login --with-token < $(workspaces.notify-config.path)/${stage}_github_token

          echo "ðŸš€ Notifiy to sync images to $stage ..."
          {
            echo "/fid env=$stage"
            yq .images[] images.yaml
          } | gh issue comment "$github_issue_url" --body-file - | tee /workspace/notify-results.${stage}.txt

          rm -f /workspace/notify.txt
          echo "âœ… Notified to sync images to $stage"
        done
    - name: notify-to-update-ops-config
      script: |
        #!/usr/bin/env bash
        set -e

        echo "ðŸš§ WIP"

    - name: notify-in-lark-channel
      script: |
        #!/usr/bin/env bash
        set -e

        for stage in prod; do
          lark_webhook_url="$(cat $(workspaces.notify-config.path)/${stage}_lark_webhook)"
          # TODO: send lark message to the webhook URL
          body_file=/workspace/lark-notify.json

          # Prepare the full text content for the notification.
          # Using a variable and then passing it to yq ensures proper escaping.
          cat <<EOF > content.txt
          images to be delivered to $stage:
          $(yq .images[] images.yaml)

          image delivery is triggered to $stage
          $(cat /workspace/notify-results.${stage}.txt)
          EOF

          yq -n '.msg_type = "text"' > $body_file
          yq --output-format json -i '.content.text = load_str("content.txt")' $body_file
          curl --fail -X POST -H 'Content-Type: application/json' -d "@$body_file" "$lark_webhook_url"

          rm -f content.txt $body_file
        done
