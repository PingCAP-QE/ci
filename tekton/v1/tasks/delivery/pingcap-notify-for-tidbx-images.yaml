# yaml-language-server: $schema=https://github.com/redhat-developer/vscode-tekton/raw/refs/heads/main/scheme/tekton.dev/v1_Task.json
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: pingcap-notify-for-tidbx-images
  labels:
    app.kubernetes.io/version: "0.1.0"
  annotations:
    tekton.dev/pipelines.minVersion: "1.0.0"
    tekton.dev/categories: delivery
    tekton.dev/tags: images,delivery
    tekton.dev/displayName: "PingCAP product Ops delivery"
    tekton.dev/platforms: "linux/amd64,linux/arm64"
spec:
  params:
    - name: src
      description: images list
  workspaces:
    - name: notify-config
      description: |
        Configuration for GitHub authentication and issue URLs.
        Include files:
        - GitHub token: <stage>_github_token
        - GitHub issue URL: <stage>_github_issue_url
      readOnly: true
  stepTemplate:
    image: ghcr.io/pingcap-qe/cd/utils/release:v2025.10.26-5-ge8130cb
  steps:
    - name: notify-to-sync-images
      script: |
        #!/usr/bin/env bash
        set -e

        cat > /workspace/images.yaml <<'EOF'
        $(params.src)
        EOF

        for stage in dev prod; do
          github_issue_url="$(cat $(workspaces.notify-config.path)/${stage}_github_issue_url)"
          gh auth login --with-token < $(workspaces.notify-config.path)/${stage}_github_token

          echo "ðŸš€ Notifiy to sync images to $stage ..."
          {
            echo "/fid env=$stage"
            yq .images[] /workspace/images.yaml
          } | gh issue comment "$github_issue_url" --body-file - | tee /workspace/notify-results.${stage}.txt

          rm -f /workspace/notify.txt
          echo "âœ… Notified to sync images to $stage"
        done

    - name: notify-in-lark-channel
      script: |
        #!/usr/bin/env bash
        set -e

        for stage in prod; do
          lark_webhook_url="$(cat $(workspaces.notify-config.path)/${stage}_lark_webhook)"

          # Prepare the full text content for the notification.
          echo "images to be delivered to $stage:" > content.txt
          yq .images[] /workspace/images.yaml >> content.txt
          echo "" >> content.txt
          echo "image delivery is triggered to $stage" >> content.txt
          cat /workspace/notify-results.${stage}.txt >> content.txt

          body_file=/workspace/lark-notify.json
          yq -n --output-format json '.msg_type = "text"' > $body_file
          yq --output-format json -i '.content.text = load_str("content.txt")' $body_file
          curl --fail -X POST -H 'Content-Type: application/json' -d "@$body_file" "$lark_webhook_url"

          rm -f content.txt $body_file
        done
    - name: notify-to-update-ops-config
      script: |
        #!/usr/bin/env bash
        set -e

        # ðŸš§ WIP, now it just is a notification placeholder

        yq '.images | filter(test ":v[0-9]+[.][0-9]+[.][0-9]+-(nextgen.[0-9]+.[0-9]+|release.[0-9]+-next-gen|next-gen)$")' /workspace/images.yaml | \
          tee /workspace/images-to-bump-on-ops.yaml

        # if none image matches `v1.2.3-nextgen.20230101.1` naming style then exit with 0.
        if yq -e 'length == 0' /workspace/images-to-bump-on-ops.yaml; then
          echo "ðŸš« No image matches for production delivery"
          exit 0
        fi

        stage="prod"
        lark_webhook_url="$(cat $(workspaces.notify-config.path)/${stage}_lark_webhook)"

        # Prepare the full text content for the notification.
        echo "âš™ï¸ Images should be bumped in $stage stage:" > content.txt
        yq .[] /workspace/images-to-bump-on-ops.yaml >> content.txt
        echo "" >> content.txt

        body_file=/workspace/lark-notify.json
        yq -n --output-format json '.msg_type = "text"' > $body_file
        yq --output-format json -i '.content.text = load_str("content.txt")' $body_file
        curl --fail -X POST -H 'Content-Type: application/json' -d "@$body_file" "$lark_webhook_url"
