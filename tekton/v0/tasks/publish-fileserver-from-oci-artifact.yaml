apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: publish-fileserver-from-oci-artifact
spec:
  description: |
    The working flow:
    1. fetch the manifect config
    2. get the `.tiup` filed from the config.
    3. loop to publish to tiup mirror.
  params:
    - name: artifact-url
      description: |
        The full url of the pushed image, contain the tag part.
        It will parse the repo from it.
    - name: publisher-url
      default: https://publisher.pingcap.net
  results:
    - name: request-ids
      type: array
  steps:
    - name: request-and-wait
      image: ghcr.io/pingcap-qe/ee-apps/publisher-cli:v2025.11.30-17-gbeadfd1
      script: |
        #!/usr/bin/env bash
        set -eo pipefail

        # send event
        /ko-app/publisher-cli --url $(params.publisher-url) fileserver request-to-publish --body '{ "artifact_url": "$(params.artifact-url)" }' | jq '. // []' | tee $(results.request-ids.path)

        # wait for request statuses
        for request_id in $(jq -r '.[]' $(results.request-ids.path)); do
          echo "ğŸ” query for request id: ${request_id} ..."
          while true; do
            status=$(/ko-app/publisher-cli --url $(params.publisher-url) fileserver query-publishing-status --request-id "$request_id" | jq -r .)
            case "${status}" in
              "failed")
                echo "âŒ Publishing failed"
                exit 1
                ;;
              "success")
                echo "âœ… Publishing successful"
                break
                ;;
              "canceled")
                echo "ğŸ’¤ Publishing canceled"
                break
                ;;
              *)
                echo "âŒ›ï¸ Status: ${status}"
                sleep 10
                ;;
            esac
          done
        done
